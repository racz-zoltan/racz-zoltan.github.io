const encryptPasscode=async e=>{const t=new TextEncoder;const n=t.encode(e);const o=await crypto.subtle.digest("SHA-256",n);const s=await crypto.subtle.importKey("raw",o,{name:"AES-GCM"},false,["encrypt","decrypt"]);const c=crypto.getRandomValues(new Uint8Array(12));const a=await crypto.subtle.encrypt({name:"AES-GCM",iv:c},s,o);const r=a.slice(-16);const l=a.slice(0,-16);localStorage.setItem("encryptedPasscode",JSON.stringify({ciphertext:Array.from(new Uint8Array(l)),nonce:Array.from(c),tag:Array.from(new Uint8Array(r))}));localStorage.setItem("lastAccessTime",Date.now().toString())};const decryptPasscode=async e=>{const t=JSON.parse(localStorage.getItem("encryptedPasscode"));if(!t)return false;const{ciphertext:n,nonce:o,tag:s}=t;const c=new TextEncoder;const a=c.encode(e);const r=await crypto.subtle.digest("SHA-256",a);const l=await crypto.subtle.importKey("raw",r,{name:"AES-GCM"},false,["decrypt"]);const i=new Uint8Array(n);const d=new Uint8Array(o);const m=new Uint8Array(s);try{const y=await crypto.subtle.decrypt({name:"AES-GCM",iv:d,additionalData:new Uint8Array,tagLength:128},l,new Uint8Array([...i,...m]));return true}catch(p){return false}};const showPasscodeModal=()=>{const e=document.getElementById("passCodeInput");e.value="";const t=document.getElementById("passCodeModal");t.style.display="block"};const hidePasscodeModal=()=>{const e=document.getElementById("passCodeInput");e.value="";const t=document.getElementById("passCodeModal");t.style.display="none"};const handlePasscodeSubmit=async()=>{const e=document.getElementById("passCodeInput");const t=e.value.trim();if(!localStorage.getItem("encryptedPasscode")){await encryptPasscode(t);hidePasscodeModal()}else{const n=await decryptPasscode(t);if(n){localStorage.setItem("lastAccessTime",Date.now().toString());document.getElementById("passCodeInput").value="";hidePasscodeModal()}else{document.getElementById("passCodeInput").value="";document.getElementById("errorMessage").innerText="Invalid passcode. Please try again."}}};document.getElementById("submitPassCode").addEventListener("click",handlePasscodeSubmit);const checkSessionTimeout=()=>{const e=parseInt(localStorage.getItem("lastAccessTime"))||0;const t=Date.now();if(t-e>5*60*1e3){showPasscodeModal()}};const resetSessionTimer=()=>{localStorage.setItem("lastAccessTime",Date.now().toString());checkSessionTimeout()};setInterval(checkSessionTimeout,60*1e3);if(!localStorage.getItem("encryptedPasscode")){showPasscodeModal()}const resetTimer=()=>{const e=parseInt(localStorage.getItem("lastAccessTime"))||0;const t=Date.now();if(t-e>5*60*1e3){showPasscodeModal()}else{localStorage.setItem("lastAccessTime",t.toString())}};const MAX_ATTEMPTS_PER_MIN=5;const RATE_LIMIT_WINDOW_MS=60*1e3;let unlockAttempts=[];function isViewerRateLimited(){const t=Date.now();unlockAttempts=unlockAttempts.filter(e=>t-e<RATE_LIMIT_WINDOW_MS);return unlockAttempts.length>=MAX_ATTEMPTS_PER_MIN}function recordViewerAttempt(){unlockAttempts.push(Date.now())}async function unlock(){if(isViewerRateLimited()){show("‚è± Rate limit exceeded. Please wait a minute and try again.");return}recordViewerAttempt();const e=document.getElementById("code").value.trim();const t=document.getElementById("totp").value.trim();if(e.length<9||t.length!==6)return showModal("Access code must be at least 9 characters and TOTP exactly 6 digits.");try{const o=await fetch("/configs/carrypass-pad.txt");const s=await o.text();const c=await fetch("/configs/carrypass-configs.json");const a=await c.json();for(const r of a){const l=`/configs/carrypass-${r.toLowerCase()}.encrypted.json`;const i=await fetch(l);const d=await i.json();for(const m of["default","shift5","pinwheel","scatter","vortex"]){try{const{k1:p,totpSecret:y}=await deriveKeysFromPad(e,s,m);const u=new TextEncoder;const g=await crypto.subtle.importKey("raw",u.encode(e),"PBKDF2",false,["deriveBits"]);const w=await crypto.subtle.deriveBits({name:"PBKDF2",salt:u.encode(p),iterations:1e5,hash:"SHA-512"},g,256);const f=await crypto.subtle.importKey("raw",w,"AES-GCM",false,["decrypt"]);const h=Uint8Array.from(atob(d.iv),e=>e.charCodeAt(0));const I=Uint8Array.from(atob(d.ciphertext),e=>e.charCodeAt(0));const A=Uint8Array.from(atob(d.tag),e=>e.charCodeAt(0));const S=new Uint8Array(I.length+A.length);S.set(I);S.set(A,I.length);const E=await crypto.subtle.decrypt({name:"AES-GCM",iv:h},f,S);const T=JSON.parse((new TextDecoder).decode(E));const v=await generateTOTP(y);if(t===v){const B=Date.now();if(T.expires&&Date.parse(T.expires)<B){show("Access denied. This config has expired.");return}decryptedConfig=T;decryptedConfig.flavor=m;document.getElementById("expiresInfo").textContent=T.expires?`üóì Expires: ${new Date(T.expires).toLocaleDateString()}`:"üóì No expiration date";document.getElementById("expiresInfo").style.display="block";const b=await caches.open("carrypass-configs-v1");const C=await b.match(l);if(C){const k=C.headers.get("date");if(k){const M=(Date.now()-Date.parse(k))/864e5;if(M>10){const x=document.getElementById("staleNotice");x.textContent=`‚ö†Ô∏è This config may be outdated (cached ${Math.floor(M)} days ago).`;x.style.display="block"}}}populateServices();resetTimer();show("‚úîÔ∏è Config unlocked successfully.\nChoose a service to view credentials.");return}}catch{}}}show("Access denied. Could not unlock any matching config.")}catch(n){console.error(n);show("Access denied. Unexpected error.")}}async function deriveKeysFromPad(e,o,t="default"){const n=new TextEncoder;const s=e.toUpperCase();const c=await crypto.subtle.digest("SHA-512",n.encode(s));const a=Array.from(new Uint8Array(c));function r(e,t){const n=a.slice(0,4).reduce((e,t)=>e<<8|t,0)%(o.length-t);return o.slice(n,n+t)}if(t==="shift5"){const m=5;return{k1:r(m,16),totpSecret:r(m+20,32).replace(/[^A-Z2-7]/g,"A")}}if(t==="pinwheel"){const i=a[10]%o.length;let t="";for(let e=0;e<32;e++){t+=o[(i+e*17)%o.length]}return{k1:r(7,16),totpSecret:t.replace(/[^A-Z2-7]/g,"A")}}if(t==="scatter"){let t=a[3];let n="";for(let e=0;e<32;e++){n+=o[(t+e*a[(e+12)%a.length])%o.length]}return{k1:r(3,16),totpSecret:n.replace(/[^A-Z2-7]/g,"A")}}if(t==="vortex"){let t="";let n=a[6]*19;for(let e=0;e<32;e++){n=(n*31+a[e%a.length])%o.length;t+=o[n]}return{k1:r(1,16),totpSecret:t.replace(/[^A-Z2-7]/g,"A")}}const l=r(0,16);let i=a[4]%(o.length-32);let d="";for(let e=0;e<32;e++){d+=o[i%o.length];i+=a[5+e%(a.length-5)]%11+1}return{k1:l,totpSecret:d.toUpperCase().replace(/[^A-Z2-7]/g,"A")}}async function generateTOTP(e){const t=base32ToBytes(e);const n=Math.floor(Date.now()/3e4);const o=new Uint8Array(8);new DataView(o.buffer).setBigUint64(0,BigInt(n));const s=await crypto.subtle.importKey("raw",t,{name:"HMAC",hash:"SHA-1"},false,["sign"]);const c=await crypto.subtle.sign("HMAC",s,o);const a=new Uint8Array(c);const r=a[a.length-1]&15;const l=(a[r]&127)<<24|a[r+1]<<16|a[r+2]<<8|a[r+3];const i=l%1e6;return i.toString().padStart(6,"0")}function base32ToBytes(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let n="",o=[];e=e.replace(/=+$/,"").toUpperCase();for(const s of e){const c=t.indexOf(s);n+=c.toString(2).padStart(5,"0")}for(let e=0;e+8<=n.length;e+=8)o.push(parseInt(n.slice(e,e+8),2));return new Uint8Array(o)}function populateServices(){const o=document.getElementById("serviceSelect");o.innerHTML="";decryptedConfig.services.forEach((e,t)=>{const n=document.createElement("option");n.value=t;n.textContent=`${e.service_name} (${e.domain})`;o.appendChild(n)});o.classList.add("form-control");o.style.display="block";document.getElementById("showBtn").style.display="block";document.getElementById("fieldsWrapper").style.display="block";const e=document.getElementById("expiresInfo");if(decryptedConfig.expires){e.textContent=`üóì Expires: ${new Date(decryptedConfig.expires).toLocaleDateString()}`;e.style.display="block"}}function showFlavorStrength(e){const t=document.getElementById("flavorStrength");let n="",o="";switch(e){case"vortex":n="Very Strong üî•";o="#4CAF50";break;case"scatter":n="Strong üîê";o="#43A047";break;case"pinwheel":n="Moderate üîÅ";o="#FFC107";break;case"shift5":n="Fair üü°";o="#FF9800";break;case"default":default:n="Basic üîì";o="#F44336";break}t.textContent=`üîç Strength: ${n}`;t.style.color=o;t.style.display="block"}function showPassword(){const e=parseInt(document.getElementById("serviceSelect").value);const t=decryptedConfig.services[e];const n=document.getElementById("userField");const o=document.getElementById("passField");const s=document.getElementById("urlField");n.type="password";o.type="password";n.value=t.username||"";o.value=t.password||"";s.value=t.domain||"";resetTimer()}function toggleVisibility(e,t){const n=document.getElementById(e);n.type=n.type==="password"?"text":"password";t.textContent=n.type==="password"?"Show":"Hide";resetTimer()}function copyInputValue(e){const t=document.getElementById(e.name);const n=document.getElementById("copySuccessIcon-"+e.getAttribute("data-password-id"));navigator.clipboard.writeText(t.value).then(()=>{n.style.display="inline";n.innerHTML='<i data-lucide="copy-check" style="color: green; font-size: 18px;"></i>';lucide.createIcons();resetTimer();setTimeout(()=>{n.style.display="none"},2e3)})["catch"](e=>{console.error("Error copying text: ",e)})}function openUrl(){const e=document.getElementById("urlField").value;if(e.startsWith("https://")){window.open(e,"_blank")}else{showModal("URL is not valid or not HTTPS.")}}function show(e){const t=document.getElementById("output");t.textContent=e}const modal=document.getElementById("alertModal");const modalImage=document.getElementById("modalImage");const closeModal=document.querySelector(".close");const showImageButton=document.getElementById("showImageButton");showImageButton.addEventListener("click",function(){modalImage.src="sample_QR.png";modalImage.style.display="block";modal.style.display="block"});closeModal.addEventListener("click",function(){modal.style.display="none";modalImage.style.display="none"});window.addEventListener("click",function(e){if(e.target===modal){modal.style.display="none";modalImage.style.display="none"}});function showModal(e){const t=document.getElementById("alertModal");const n=document.getElementById("alertModalMessage");n.textContent=e;t.style.display="block";const o=document.getElementsByClassName("close")[0];o.onclick=function(){t.style.display="none"};window.onclick=function(e){if(e.target===t){t.style.display="none"}}}function showAlert(e,t="info",n=document.body){const o=document.createElement("div");o.className=`custom-alert custom-alert-${t}`;o.innerHTML=`
    <span>${e}</span>
    <button class="custom-alert-close" onclick="this.parentElement.remove()">√ó</button>
  `;n.prepend(o);setTimeout(()=>{o.remove()},4e3)}function switchOff(){const e=Date.now();let t=e-10*60*1e3;localStorage.setItem("lastAccessTime",t.toString());const n=document.getElementById("passCodeInput");n.value="";showPasscodeModal()}window.addEventListener("load",checkSessionTimeout);window.addEventListener("popstate",checkSessionTimeout);window.addEventListener("hashchange",checkSessionTimeout);