window._editingCredential=null;const MAX_CALLS_PER_MINUTE=5;const RATE_LIMIT_WINDOW=60*1e3;let callTimes=[];function isRateLimited(){const currentTime=Date.now();callTimes=callTimes.filter(time=>currentTime-time<RATE_LIMIT_WINDOW);return callTimes.length>=MAX_CALLS_PER_MINUTE}function updateCounter(){callTimes.push(Date.now())}const MAX_ATTEMPTS_PER_MIN=5;const RATE_LIMIT_WINDOW_MS=60*1e3;let unlockAttempts=[];function isViewerRateLimited(){const now=Date.now();unlockAttempts=unlockAttempts.filter(ts=>now-ts<RATE_LIMIT_WINDOW_MS);return unlockAttempts.length>=MAX_ATTEMPTS_PER_MIN}function recordViewerAttempt(){unlockAttempts.push(Date.now())}function confirmModal(message){return new Promise(resolve=>{showConfirmation(message,result=>resolve(result))})}function enforceDigitInput(inputId){const inputElement=document.getElementById(inputId);if(!inputElement)return;inputElement.addEventListener("input",function(){this.value=this.value.replace(/[^0-9]/g,"")})}enforceDigitInput("iterationCount");const CHARSETS={alphaNumeric:"s5zX7K9tHy5CkE2I8RvQcYfOu1M8Wr42eG3gZxDq6aFbhT4jJi3LN0lAUpP7nwB6VdoS",numericAlpha:"n0tHyaFX4GvE3IZ2qYf8WP1cKuC5s7Bw6jJi3L9RzDaVQp7oYlAM86gSdE42rXbKTU9x5ZDfGq1eC",alphaOnly:"cOpMniQyTmSvwklVJuIjgKtNrLEoRhXYZqaxiHdsPWzDfUeGbAFB",lowerAlpha:"qazxswedcvfrtgbnhyujmkilopgfdwrtmnbvcxqsapluhokjyezi",numbers:"7294053861",special:"QP}v7$D6{+[(Cw^,e5&@uB^Jq.]Gd4=VLuPYN5o;Hk*WgF_a4Xh!lbczr8]Z2Iy9(R03N-1tA<EjSM|)iOT2sfxK>mU1%`:n?"};function pbkdf2Hash(input,salt,length,iterations=1e5){return CryptoJS.PBKDF2(input,salt,{keySize:length/4,iterations:iterations,hasher:CryptoJS.algo.SHA256})}function deterministicInsert(str,char,seed){const pos=seed.charCodeAt(0)%str.length;return str.slice(0,pos)+char+str.slice(pos+1)}function formatKey(bytes,length,charset,rules=[],input=""){let result="",has={};for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);result+=char;rules.forEach(rule=>has[rule]||=new RegExp(rule).test(char))}if(rules.length&&!rules.every(rule=>has[rule])){if(!has["[a-z]"])result=deterministicInsert(result,"g",input);if(!has["[A-Z]"])result=deterministicInsert(result,"T",input);if(!has["[0-9]"])result=deterministicInsert(result,"4",input);if(!has["[!@#$%^&*()-_=+[]{}|;:,.<>?]"])result=deterministicInsert(result,"!",input)}return result.slice(0,length)}function segmentKey(key,segmentSize=7){let output="",i=0;while(i+segmentSize<key.length){output+=key.slice(i,i+segmentSize)+"-";i+=segmentSize}return output+key.slice(i)}function generateRandomPasswordKey(webAddress,password,iterationCount,salt,length){const raw=formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.alphaNumeric,["[a-z]","[A-Z]","[0-9]"],password);return segmentKey(raw,7)}function generateRandomLetterKey(webAddress,password,iterationCount,salt,length){return formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.alphaOnly,["[a-z]","[A-Z]"],password)}function generateRandomUsername(webAddress,password,iterationCount,salt,length){return formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.lowerAlpha,[],password)}function generateRandomNumberKey(webAddress,password,iterationCount,salt,length){return formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.numbers,[],password)}function generateRandomMixedKey(webAddress,password,iterationCount,salt,length){return formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.numericAlpha,["[a-z]","[A-Z]","[0-9]"],password)}function generateRandomSpecialKey(webAddress,password,iterationCount,salt,length){return formatKey(pbkdf2Hash(webAddress+password,salt,length,iterationCount),length,CHARSETS.special,["[a-z]","[A-Z]","[0-9]","[!@#$%^&*()-_=+[]{}|;:,.<>?]"],password)}function bytesToAlphaNumericString(bytes){let charset="s5zX7K9tHy5CkE2I8RvQcYfOu1M8Wr42eG3gZxDq6aFbhT4jJi3LN0lAUpP7nwB6VdoS";let result="";let hasLowercase=false;let hasUppercase=false;let hasDigit=false;for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);if(!hasLowercase&&/[a-z]/.test(char)){hasLowercase=true}else if(!hasUppercase&&/[A-Z]/.test(char)){hasUppercase=true}else if(!hasDigit&&/[0-9]/.test(char)){hasDigit=true}result+=char}if(!(hasLowercase&&hasUppercase&&hasDigit)){return bytesToAlphaNumericString(bytes)}return result}function bytesToNumericAlphaString(bytes){let charset="n0tHyaFX4GvE3IZ2qYf8WP1cKuC5s7Bw6jJi3L9RzDaVQp7oYlAM86gSdE42rXbKTU9x5ZDfGq1eC";let result="";let hasLowercase=false;let hasUppercase=false;let hasDigit=false;for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);if(!hasLowercase&&/[a-z]/.test(char)){hasLowercase=true}else if(!hasUppercase&&/[A-Z]/.test(char)){hasUppercase=true}else if(!hasDigit&&/[0-9]/.test(char)){hasDigit=true}result+=char}if(!(hasLowercase&&hasUppercase&&hasDigit)){return bytesToNumericAlphaString(bytes)}return result}function bytesToAlphaString(bytes){let charset="cOpMniQyTmSvwklVJuIjgKtNrLEoRhXYZqaxiHdsPWzDfUeGbAFB";let result="";let hasLowercase=false;let hasUppercase=false;for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);if(!hasLowercase&&/[a-z]/.test(char)){hasLowercase=true}else if(!hasUppercase&&/[A-Z]/.test(char)){hasUppercase=true}result+=char}if(!(hasLowercase&&hasUppercase)){return bytesToAlphaString(bytes)}return result}function bytesToLowerAlphaString(bytes){let charset="qazxswedcvfrtgbnhyujmkilopgfdwrtmnbvcxqsapluhokjyezi";let result="";for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);result+=char}return result}function bytesToMoreSpecialString(bytes){let charset="QP}v7$D6{+[(Cw^,e5&@uB^Jq.]Gd4=VLuPYN5o;Hk*WgF_a4Xh!lbczr8]Z2Iy9(R03N-1tA<EjSM|)iOT2sfxK>mU1%`:n?";let result="";let hasLowercase=false;let hasUppercase=false;let hasDigit=false;let hasPunctuation=false;for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);if(!hasLowercase&&/[a-z]/.test(char)){hasLowercase=true}else if(!hasUppercase&&/[A-Z]/.test(char)){hasUppercase=true}else if(!hasDigit&&/[0-9]/.test(char)){hasDigit=true}else if(!hasPunctuation&&/[!@#$%^&*()-_=+[\]{}|;:,.<>?]/.test(char)){hasPunctuation=true}result+=char}if(!(hasLowercase&&hasUppercase&&hasDigit&&hasPunctuation)){return bytesToMoreSpecialString(bytes)}return result}function bytesToNumericString(bytes){let charset="7294053861";let result="";for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);result+=char}return result}async function generateKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}var webAdd=document.getElementById("webAddress").value;var passwordValue=document.getElementById("password").value;var lengthValue=document.getElementById("length").value;var iterationValue=document.getElementById("iterationCount").value;const alertContainer=document.getElementById("alert-container")||document.body;if(webAdd==""||passwordValue==""||lengthValue==""||iterationValue==""){showAlert("Input fields cannot be empty.","info",alertContainer);return}if(lengthValue<1){showAlert("Length has to be larger than 0.","info",alertContainer);return}if(iterationValue<1){showAlert("Iteration has to be larger than 0.","info",alertContainer);return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomPasswordKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomPasswordKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}function generateNumbers(initialInput){const inputString=initialInput.toString();const hash=CryptoJS.SHA256(inputString);const hashChunks=hash.toString(CryptoJS.enc.Hex).match(/.{1,10}/g).slice(0,6);const numbers=hashChunks.map(chunk=>{const hexNumber=parseInt(chunk,16);let fiveDigitNumber=hexNumber%40001+3e4;if(fiveDigitNumber>7e4){fiveDigitNumber-=1e4}return fiveDigitNumber});return numbers}async function generateAlphaNumKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}var webAdd=document.getElementById("webAddress").value;var passwordValue=document.getElementById("password").value;var lengthValue=document.getElementById("length").value;var iterationValue=document.getElementById("iterationCount").value;const alertContainer=document.getElementById("alert-container")||document.body;if(webAdd==""||passwordValue==""||lengthValue==""||iterationValue==""){showAlert("Input fields cannot be empty.","info",alertContainer);return}if(lengthValue<1){showAlert("Length has to be larger than 0.","info",alertContainer);return}if(iterationValue<1){showAlert("Iteration has to be larger than 0.","info",alertContainer);return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomMixedKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomMixedKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}async function generateLetterKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}var webAdd=document.getElementById("webAddress").value;var passwordValue=document.getElementById("password").value;var lengthValue=document.getElementById("length").value;var iterationValue=document.getElementById("iterationCount").value;const alertContainer=document.getElementById("alert-container")||document.body;if(webAdd==""||passwordValue==""||lengthValue==""||iterationValue==""){showAlert("Input fields cannot be empty.","info",alertContainer);return}if(lengthValue<1){showAlert("Length has to be larger than 0.","info",alertContainer);return}if(iterationValue<1){showAlert("Iteration has to be larger than 0.","info",alertContainer);return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomLetterKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomLetterKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}async function generateUsername(){let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=14;let key=generateRandomUsername(webAddress,password,iterationCount,salt,length);document.getElementById("username").value=key}async function generateNumberKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}var webAdd=document.getElementById("webAddress").value;var passwordValue=document.getElementById("password").value;var lengthValue=document.getElementById("length").value;var iterationValue=document.getElementById("iterationCount").value;const alertContainer=document.getElementById("alert-container")||document.body;if(webAdd==""||passwordValue==""||lengthValue==""||iterationValue==""){showAlert("Input fields cannot be empty.","info",alertContainer);return}if(lengthValue<1){showAlert("Length has to be larger than 0.","info",alertContainer);return}if(iterationValue<1){showAlert("Iteration has to be larger than 0.","info",alertContainer);return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomNumberKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomNumberKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}async function generateMixedKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomMixedKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomMixedKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}async function generateSpecialKey(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}var webAdd=document.getElementById("webAddress").value;var passwordValue=document.getElementById("password").value;var lengthValue=document.getElementById("length").value;var iterationValue=document.getElementById("iterationCount").value;const alertContainer=document.getElementById("alert-container")||document.body;if(webAdd==""||passwordValue==""||lengthValue==""||iterationValue==""){showAlert("Input fields cannot be empty.","info",alertContainer);return}if(lengthValue<1){showAlert("Length has to be larger than 0.","info",alertContainer);return}if(iterationValue<1){showAlert("Iteration has to be larger than 0.","info",alertContainer);return}generateWithMaster();showLoadingDots();await new Promise(resolve=>setTimeout(resolve,200));let webAddress=document.getElementById("webAddress").value;let password=document.getElementById("password").value;let iterationCount=document.getElementById("iterationCount").value;let salt=document.getElementById("salt").value;let length=document.getElementById("length").value;let supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];let stringIteration=iterationCount.toString();let initialInput=stringIteration+password+salt+webAddress;let generatedNumbers=generateNumbers(initialInput);for(let i=0;i<5;i++){let key=generateRandomSpecialKey(webAddress,password,generatedNumbers[i],salt,length);document.getElementById(supplementaryInputs[i]).value=key}let key=generateRandomSpecialKey(webAddress,password,iterationCount,salt,length);document.getElementById("mainPassword").value=key;generatePasswordAndTrigger(key);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("iterationCount").value="";document.getElementById("salt").value="";document.getElementById("length").value="";updateCounter();hideLoadingDots();resetTimer()}async function encryptTextWithPassword(plaintext,password){const{salt,iv}=await deriveAesParamsFromPassword(password);const keyMaterial=await crypto.subtle.importKey("raw",(new TextEncoder).encode(password),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-512"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt"]);const encoded=(new TextEncoder).encode(plaintext);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,encoded);return btoa(String.fromCharCode(...new Uint8Array(encrypted)))}async function decryptTextWithPassword(encryptedB64,password){const{salt,iv}=await deriveAesParamsFromPassword(password);const keyMaterial=await crypto.subtle.importKey("raw",(new TextEncoder).encode(password),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-512"},keyMaterial,{name:"AES-GCM",length:256},false,["decrypt"]);const encrypted=Uint8Array.from(atob(encryptedB64),c=>c.charCodeAt(0));const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,encrypted);return(new TextDecoder).decode(decrypted)}async function encryptText(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}let plaintext=document.getElementById("plaintext").value;let encryptionPassword=document.getElementById("encryptionPassword").value;const alertContainer=document.getElementById("alert-container")||document.body;if(!encryptionPassword.trim()){showModal("Password input field cannot be empty.");return}try{const encrypted=await encryptTextWithPassword(plaintext,encryptionPassword);document.getElementById("encryptedText").value=encrypted;document.getElementById("plaintext").value="";document.getElementById("encryptionPassword").value=""}catch(err){showModal("Encryption failed. Please try again.")}document.getElementById("encrypted").scrollIntoView({behavior:"smooth",block:"start"});updateCounter();resetTimer()}function copyEncryptedText(){let encryptedText=document.getElementById("encryptedText").value;const alertContainer=document.getElementById("alert-container")||document.body;copyToClipboard(encryptedText);showAlert("Encrypted text copied to clipboard.","success",alertContainer)}async function decryptText(){if(isRateLimited()){showModal("You have exceeded the rate limit. Please try again later.");return}let encryptedText=document.getElementById("encryptedText").value;let decryptionPassword=document.getElementById("decryptionPassword").value;const alertContainer=document.getElementById("alert-container")||document.body;if(!decryptionPassword.trim()){showModal("Password input field cannot be empty.");return}try{let decrypted=await decryptTextWithPassword(encryptedText,decryptionPassword);if(decrypted){document.getElementById("plaintext").value=decrypted;document.getElementById("encryptedText").value="";document.getElementById("decryptionPassword").value=""}else{showModal("Decryption failed: incorrect password.")}}catch(error){showModal("Decryption failed. Please check your password and try again.")}document.getElementById("start").scrollIntoView({behavior:"smooth",block:"start"});updateCounter();resetTimer()}function copyDecryptedText(){let plaintext=document.getElementById("plaintext").value;const alertContainer=document.getElementById("alert-container")||document.body;copyToClipboard(plaintext);showAlert("Decrypted text copied to clipboard.","success",alertContainer)}async function copyToClipboard(text){try{await navigator.clipboard.writeText(text)}catch(err){showModal("Failed to copy text to clipboard.")}}function copyInputValue(button){const passwordField=document.getElementById(button.name);const successIcon=document.getElementById("copySuccessIcon-"+button.getAttribute("data-password-id"));navigator.clipboard.writeText(passwordField.value).then(()=>{successIcon.style.display="inline";successIcon.innerHTML='<i data-lucide="copy-check" style="color: green; font-size: 18px;"></i>';lucide.createIcons();resetTimer();setTimeout(()=>{successIcon.style.display="none"},2e3)})["catch"](err=>{console.error("Error copying text: ",err)})}function showAlert(message,type="info",container=document.body){const alert=document.createElement("div");alert.className=`custom-alert custom-alert-${type}`;alert.innerHTML=`
    <span>${message}</span>
    <button class="custom-alert-close" onclick="this.parentElement.remove()">×</button>
  `;container.prepend(alert);setTimeout(()=>{alert.remove()},4e3)}function generateWithMaster(){var webAddress=document.getElementById("webAddress").value;var password=document.getElementById("password").value;const alertContainer=document.getElementById("alert-container")||document.body;var input=webAddress+password;var base32Chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";if(webAddress!=""&&password!=""){while(input.length<32){input+=input}input=input.slice(0,32)}else{showAlert("Application name and Master password input fields cannot be empty.","info",alertContainer)}var base64=btoa(input);var result="";for(var i=0;i<base64.length;i++){var char=base64.charAt(i);if(char!=="="){var index=char.charCodeAt(0);if(index===43)index=62;else if(index===47)index=63;result+=base32Chars[index>>2];result+=base32Chars[(index&3)<<3|base64.charCodeAt(++i)>>5];result+=base32Chars[base64.charCodeAt(i)&31]}}result=result.slice(0,32);document.getElementById("salt").value=result;document.getElementById("keyGeneratorForm").addEventListener("submit",function(event){event.preventDefault()})}function showMaster(){var passwordinput=document.getElementById("password");var showbutton=document.getElementById("showbutton");if(passwordinput.type=="password"){showbutton.textContent="Hide";passwordinput.setAttribute("type","text")}else{showbutton.textContent="Show";passwordinput.setAttribute("type","password")}}function showManyPassword(button){const inputId=button.name;const passwordInput=document.getElementById(inputId);if(!passwordInput){showAlert(`No field found for: ${inputId}`,"error");return}if(passwordInput.type==="password"){passwordInput.type="text";button.textContent="Hide"}else{passwordInput.type="password";button.textContent="Show"}}function clearAllPassword(){resetTimer();document.getElementById("mainPassword").value="";document.getElementById("supplementaryone").value="";document.getElementById("supplementarytwo").value="";document.getElementById("supplementarythree").value="";document.getElementById("supplementaryfour").value="";document.getElementById("supplementaryfive").value="";document.getElementById("username").value="";document.getElementById("createdfor").innerHTML="";let additional=document.getElementById("additionalPasswords");let generated=document.getElementById("generatedPassword");hideSmooth(additional);hideSmooth(generated);generatePasswordAndTrigger("")}if("serviceWorker"in navigator){window.addEventListener("load",function(){navigator.serviceWorker.register("/service-worker.js").then(function(registration){},function(err){console.error("ServiceWorker registration failed: ",err)})})}async function deriveAesParamsFromPassword(password){const encoder=new TextEncoder;const base=password.padEnd(64,password).slice(0,64).toUpperCase();const hash=await crypto.subtle.digest("SHA-512",encoder.encode(base));const bytes=new Uint8Array(hash);const salt=bytes.slice(0,16);const iv=bytes.slice(16,28);return{salt:salt,iv:iv}}async function encryptFile(){const fileInput=document.getElementById("fileInput");const password=document.getElementById("password1").value;if(!fileInput.files.length||!password.trim())return showModal("Please select a file and enter a password.");const file=fileInput.files[0];const reader=new FileReader;reader.onload=async function(){try{const{salt,iv}=await deriveAesParamsFromPassword(password);const keyMaterial=await crypto.subtle.importKey("raw",(new TextEncoder).encode(password),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-512"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt"]);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,reader.result);const blob=new Blob([encrypted],{type:file.type});const filename=file.name.replace(/\.[^/.]+$/,"")+"[encrypted]"+file.name.substring(file.name.lastIndexOf("."));const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);document.getElementById("password1").value="";resetSessionTimer();const fileInput=document.getElementById("fileInput");const fileInputText=document.getElementById("fileInputText");fileInput.value="";fileInputText.value="Choose file"}catch(e){showModal("Encryption failed. Please try again.")}};reader.readAsArrayBuffer(file)}async function decryptFile(){const encryptedFileInput=document.getElementById("encryptedFileInput");const password=document.getElementById("password2").value;if(!encryptedFileInput.files.length||!password.trim())return showModal("Please select a file and enter a password.");const file=encryptedFileInput.files[0];const reader=new FileReader;reader.onload=async function(){try{const{salt,iv}=await deriveAesParamsFromPassword(password);const keyMaterial=await crypto.subtle.importKey("raw",(new TextEncoder).encode(password),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-512"},keyMaterial,{name:"AES-GCM",length:256},false,["decrypt"]);const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,reader.result);const blob=new Blob([decrypted],{type:file.type});const filename=file.name.replace(/\.[^/.]+$/,"")+"[decrypted]"+file.name.substring(file.name.lastIndexOf("."));const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);document.getElementById("password2").value="";const fileInput=document.getElementById("encryptedFileInput");const fileInputText=document.getElementById("fileInputTextDecrypt");fileInput.value="";fileInputText.value="Choose file";resetSessionTimer()}catch(e){showModal("Decryption failed. Incorrect password.");document.getElementById("password2").value=""}};reader.readAsArrayBuffer(file)}function updateFileName(){const fileInput=document.getElementById("fileInput");const fileInputText=document.getElementById("fileInputText");const fileName=fileInput.files[0]?fileInput.files[0].name:"Choose file";fileInputText.value=fileName}const fileButton=document.getElementById("fileButton");const fileInput=document.getElementById("fileInput");if(fileButton&&fileInput){fileButton.addEventListener("click",function(){fileInput.click()})}function updateFileNameDecrypt(){const fileInput=document.getElementById("encryptedFileInput");const fileInputText=document.getElementById("fileInputTextDecrypt");const fileName=fileInput.files[0]?fileInput.files[0].name:"Choose file";fileInputText.value=fileName}const fileButtonDecrypt=document.getElementById("fileButtonDecrypt");const encryptedFileInput=document.getElementById("encryptedFileInput");if(fileButtonDecrypt&&encryptedFileInput){fileButtonDecrypt.addEventListener("click",function(){encryptedFileInput.click()})}document.addEventListener("DOMContentLoaded",function(){const navLinks=document.querySelectorAll(".nav-link");navLinks.forEach(function(navLink){navLink.addEventListener("click",function(){const navbarCollapse=document.querySelector(".navbar-collapse");if(navbarCollapse.classList.contains("show")){navbarCollapse.classList.remove("show")}})})});function showModal(message){const modal=document.getElementById("alertModalAlert");const modalMessage=document.getElementById("alertModalMessage");modalMessage.textContent=message;modal.style.display="block";const closeButton=document.getElementsByClassName("close")[0];closeButton.onclick=function(){modal.style.display="none"};window.onclick=function(event){if(event.target===modal){modal.style.display="none"}}}function showModalWorker(message,callback){const modal=document.getElementById("myModal");const modalMessage=document.getElementById("modalMessage");modalMessage.textContent=message;modal.style.display="block";const confirmButton=document.getElementById("modalConfirm");confirmButton.onclick=function(){modal.style.display="none";callback(true)};const cancelButton=document.getElementById("modalCancel");cancelButton.onclick=function(){modal.style.display="none";callback(false)}}function showLoadingDots(){document.getElementById("loadingModal").style.display="block"}function hideLoadingDots(){document.getElementById("loadingModal").style.display="none"}function calculateEntropy(password){if(!password)return 0;const charsetSize=getCharsetSize(password);return password.length*Math.log2(charsetSize)}function getCharsetSize(password){const uniqueChars=new Set(password.split(""));return uniqueChars.size}function updatePasswordStrength(password){const strengthBar=document.getElementById("passwordStrengthBar");const strengthText=document.getElementById("passwordStrengthText");const entropyText=document.getElementById("entropyText");let score=0;let hasLower=/[a-z]/.test(password);let hasUpper=/[A-Z]/.test(password);let hasDigit=/\d/.test(password);let hasSpecial=/[!@#$%^&*(),.?":{}|<>]/.test(password);if(!password){strengthText.innerText="";strengthBar.className="";entropyText.innerText="";strengthText.style.color="blue";return}if(password.length>=12){score++}if(password.length>=17){score++}if(hasLower)score++;if(hasUpper)score++;if(hasDigit)score++;if(hasSpecial)score++;const entropy=calculateEntropy(password);let entropyScore=0;let entropyLevel="Low Entropy";if(entropy<30){entropyScore=1;entropyLevel="Low Entropy"}else if(entropy>=30&&entropy<56){entropyScore=2;entropyLevel="Medium Entropy"}else if(entropy>=56&&entropy<85){entropyScore=4;entropyLevel="High Entropy"}else{entropyScore=6;entropyLevel="Extra Strong"}score+=entropyScore;entropyText.innerText=`Entropy: ${entropy.toFixed(2)} (${entropyLevel})`;let strengthLevel="Weak";let strengthColor="red";if(score<=5){strengthLevel="Weak";strengthColor="red"}else if(score<=8){strengthLevel="Medium";strengthColor="orange"}else if(score<=10){strengthLevel="Strong";strengthColor="green"}else{strengthLevel="Extra Strong";strengthColor="purple"}strengthBar.className="";strengthBar.classList.add(strengthLevel.toLowerCase().replace(" ",""));strengthText.innerText=strengthLevel;strengthText.style.color=strengthColor}function generatePasswordAndTrigger(password){document.getElementById("mainPassword").value=password;updatePasswordStrength(password)}function copyPasswordCheck(button){resetTimer();const passwordField=document.getElementById(button.name);const successIcon=document.getElementById("copySuccessIcon-"+button.getAttribute("data-password-id"));navigator.clipboard.writeText(passwordField.value).then(()=>{successIcon.style.display="inline";successIcon.innerHTML='<i data-lucide="copy-check" style="color: green; font-size: 18px;"></i>';lucide.createIcons();setTimeout(()=>{successIcon.style.display="none"},2e3)})["catch"](err=>{console.error("Error copying text: ",err)})}function copyPasswordCheckAfterGeneration(){const successIcon=document.getElementById("copySuccessIcon-mainCopy");successIcon.style.display="inline";successIcon.innerHTML='<i data-lucide="copy-check" style="color: green; font-size: 18px;"></i>';lucide.createIcons();setTimeout(()=>{successIcon.style.display="none"},2e3)}const encryptPasscode=async passcode=>{const encoder=new TextEncoder;const data=encoder.encode(passcode);const passwordHash=await crypto.subtle.digest("SHA-256",data);const key=await crypto.subtle.importKey("raw",passwordHash,{name:"AES-GCM"},false,["encrypt","decrypt"]);const nonce=crypto.getRandomValues(new Uint8Array(12));const cipherText=await crypto.subtle.encrypt({name:"AES-GCM",iv:nonce},key,passwordHash);const tag=cipherText.slice(-16);const ciphertextWithoutTag=cipherText.slice(0,-16);localStorage.setItem("encryptedPasscode",JSON.stringify({ciphertext:Array.from(new Uint8Array(ciphertextWithoutTag)),nonce:Array.from(nonce),tag:Array.from(new Uint8Array(tag))}));localStorage.setItem("lastAccessTime",Date.now().toString())};const decryptPasscode=async enteredPasscode=>{const storedData=JSON.parse(localStorage.getItem("encryptedPasscode"));if(!storedData)return false;const{ciphertext,nonce,tag}=storedData;const encoder=new TextEncoder;const data=encoder.encode(enteredPasscode);const passwordHash=await crypto.subtle.digest("SHA-256",data);const key=await crypto.subtle.importKey("raw",passwordHash,{name:"AES-GCM"},false,["decrypt"]);const ciphertextUint8=new Uint8Array(ciphertext);const nonceUint8=new Uint8Array(nonce);const tagUint8=new Uint8Array(tag);try{const decryptedData=await crypto.subtle.decrypt({name:"AES-GCM",iv:nonceUint8,additionalData:new Uint8Array,tagLength:128},key,new Uint8Array([...ciphertextUint8,...tagUint8]));return true}catch(e){return false}};const handlePasscodeSubmit=async mode=>{if(mode==="register"){const passcodeRegister=document.getElementById("passCodeInputRegister")?.value.trim();const passcodeRegisterInput=document.getElementById("passCodeInputRegister");if(!passcodeRegister||passcodeRegister.length<6){showModalAlert("Your application ID must be at least 6 characters.");return}await encryptPasscode(passcodeRegister);await deriveSessionKey(passcodeRegister);passcodeRegisterInput.value="";showScreen("appView");return}const passcode=document.getElementById("passCodeInput")?.value.trim();const passcodeInput=document.getElementById("passCodeInput");if(!passcode||passcode.length<6){showModalAlert("Your application ID must be at least 6 characters.");return}const isValid=await decryptPasscode(passcode);if(isValid){localStorage.setItem("lastAccessTime",Date.now().toString());passcodeInput.value="";await deriveSessionKey(passcode);buildSavedServicesList();showScreen("appView")}else{showModalAlert("Invalid Application ID. Please try again.")}};document.getElementById("submitPassCode").addEventListener("click",()=>handlePasscodeSubmit("login"));document.getElementById("submitPassCodeRegister").addEventListener("click",()=>handlePasscodeSubmit("register"));let sessionKey=null;async function deriveSessionKey(passcode){const encoder=new TextEncoder;const hash=await crypto.subtle.digest("SHA-256",encoder.encode(passcode));const key=await crypto.subtle.importKey("raw",hash,{name:"AES-GCM"},false,["encrypt","decrypt"]);sessionKey=key}const saveSettings=async()=>{const rawAddress=document.getElementById("webAddress").value.trim();const normalized=normalizeServiceName(rawAddress);if(!normalized)return;const settings={webAddress:rawAddress,length:document.getElementById("length").value,iterationCount:document.getElementById("iterationCount").value,letters:document.getElementById("toggle1").checked,numbers:document.getElementById("toggle2").checked,symbols:document.getElementById("toggle3").checked,separator:document.getElementById("toggle4").checked};await encryptSettings(normalized,settings);buildSavedServicesList()};const encryptSettings=async(serviceName,settings)=>{if(!sessionKey){console.error("No session key.");return}const encoder=new TextEncoder;const data=encoder.encode(JSON.stringify(settings));const nonce=crypto.getRandomValues(new Uint8Array(12));const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:nonce},sessionKey,data);const tag=encrypted.slice(-16);const ciphertextWithoutTag=encrypted.slice(0,-16);localStorage.setItem(`encryptedSettings_${serviceName}`,JSON.stringify({ciphertext:Array.from(new Uint8Array(ciphertextWithoutTag)),nonce:Array.from(nonce),tag:Array.from(new Uint8Array(tag))}))};const decryptSettingsFromMemory=async serviceName=>{if(!sessionKey){console.error("No session key available. Cannot decrypt settings.");return null}const storedRaw=localStorage.getItem(`encryptedSettings_${serviceName}`);if(!storedRaw){return null}const stored=JSON.parse(storedRaw);const ciphertext=new Uint8Array(stored.ciphertext.concat(stored.tag));const nonce=new Uint8Array(stored.nonce);try{const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:nonce},sessionKey,ciphertext);const decoded=(new TextDecoder).decode(decrypted);return JSON.parse(decoded)}catch(e){return null}};let lastLoadedService="";document.getElementById("webAddress").addEventListener("input",()=>{const currentInput=normalizeServiceName(document.getElementById("webAddress").value.trim());if(lastLoadedService&&currentInput!==lastLoadedService){document.getElementById("length").value="28";document.getElementById("iterationCount").value="100";document.getElementById("toggle1").checked=true;document.getElementById("toggle2").checked=true;document.getElementById("toggle3").checked=false;document.getElementById("toggle4").checked=true;updateArgonTierLabel()}});document.getElementById("webAddress").addEventListener("blur",async()=>{const webAddressInput=document.getElementById("webAddress").value.trim();const normalized=normalizeServiceName(webAddressInput);if(!normalized)return;const settings=await decryptSettingsFromMemory(normalized);if(!settings){document.getElementById("length").value="28";document.getElementById("iterationCount").value="100";document.getElementById("toggle1").checked=true;document.getElementById("toggle2").checked=true;document.getElementById("toggle3").checked=false;document.getElementById("toggle4").checked=true;const dot=document.getElementById("dot");dot.style.backgroundColor="red";updateArgonTierLabel();lastLoadedService="";return}document.getElementById("webAddress").value=settings.webAddress;document.getElementById("length").value=settings.length;document.getElementById("iterationCount").value=settings.iterationCount;document.getElementById("toggle1").checked=settings.letters;document.getElementById("toggle2").checked=settings.numbers;document.getElementById("toggle3").checked=settings.symbols;document.getElementById("toggle4").checked=settings.separator;updateArgonTierLabel();const dot=document.getElementById("dot");dot.style.backgroundColor="green";lastLoadedService=normalized});const checkSessionTimeout=()=>{const lastAccessTime=parseInt(localStorage.getItem("lastAccessTime"))||0;const currentTime=Date.now();if(currentTime-lastAccessTime>15*60*1e3){const storedPasscode=localStorage.getItem("encryptedPasscode");sessionKey="";if(storedPasscode){showScreen("loginView")}else{showScreen("registrationView")}}};const resetSessionTimer=()=>{localStorage.setItem("lastAccessTime",Date.now().toString());checkSessionTimeout()};setInterval(checkSessionTimeout,60*1e3);if(!localStorage.getItem("encryptedPasscode")){showScreen("registrationView")}document.addEventListener("click",e=>{const link=e.target.closest("[data-section]");if(!link)return;e.preventDefault();const screenId=link.getAttribute("data-section");showScreen(screenId)});function clearSensitiveInputs(){const fieldIds=["memberId","memberPassword","memberTOTPInput","adminAccessInput","adminPasswordInput","adminTOTPInput","adminPasswordEditorInput","adminEditorTOTPInput","passCodeInput","passCodeInputRegister"];fieldIds.forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const fileInputs=document.querySelectorAll('input[type="file"]');fileInputs.forEach(input=>{input.value=""})}function showScreen(screenId){document.querySelectorAll(".screen").forEach(screen=>{if(screen.id===screenId){screen.style.display="block";screen.classList.remove("active");void screen.offsetWidth;setTimeout(()=>{screen.classList.add("active")},10)}else{screen.classList.remove("active");setTimeout(()=>{screen.style.display="none"},400)}});if((screenId==="loginView"||screenId==="registrationView")&&document.querySelector('.modal.active, .modal.visible, .modal.show, .modal[open], .modal[style*="block"]')){closeAllModals()}clearSensitiveInputs()}const resetTimer=()=>{const lastAccessTime=parseInt(localStorage.getItem("lastAccessTime"))||0;const currentTime=Date.now();if(currentTime-lastAccessTime>5*60*1e3){const storedPasscode=localStorage.getItem("encryptedPasscode");sessionKey="";if(storedPasscode){showScreen("loginView")}else{showScreen("registrationView")}}else{localStorage.setItem("lastAccessTime",currentTime.toString())}};function closeAllModals(){if(window.openModals){window.openModals.forEach(closeFn=>{try{if(typeof closeFn==="function")closeFn()}catch(e){console.warn("Error closing tracked modal:",e)}});window.openModals=[]}document.querySelectorAll(".modal").forEach(modal=>{modal.classList.remove("active","visible","show");if(!modal.classList.contains("hidden")){modal.classList.add("hidden")}modal.style.display="none";if(typeof modal.close==="function"&&modal.hasAttribute("open")){try{modal.close()}catch(e){}}});document.querySelectorAll(".modal-backdrop").forEach(b=>b.remove())}function switchOff(){const currentTime=Date.now();const tenMinutesAgo=currentTime-10*60*1e3;localStorage.setItem("lastAccessTime",tenMinutesAgo.toString());document.querySelectorAll("input, textarea").forEach(el=>{if(el.type!=="checkbox"&&el.type!=="radio"){el.value=""}else{el.checked=false}});["mainPassword","username","supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"].forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});sessionKey="";document.querySelectorAll(".modal, .modal-edit, .modal-confirm, .carrypass-modal").forEach(modal=>{modal.classList.add("hidden");modal.classList.remove("active");modal.style.display="none"});const backdrop=document.getElementById("modalBackdrop");if(backdrop)backdrop.classList.add("hidden");document.querySelectorAll(".modal-error").forEach(errBox=>{errBox.textContent="";errBox.classList.add("hidden");errBox.classList.remove("active")});vault={};adminConfig=null;securelyEraseMemory();const fieldsToClear=["adminAccessInput","adminPasswordInput","adminTOTPInput","adminPasswordEditorInput","adminEditorTOTPInput"];fieldsToClear.forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const elementsToClear=["teamsList","membersList","credentialsList","assignmentsList","vaultExportFeedback","vaultExpirationDisplay"];elementsToClear.forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=""});const searchInputs=["teamSearchInput","memberSearchInput","credentialSearchInput","credentialSearchByTeam","assignmentSearchInput","assignmentSearchByTeam"];searchInputs.forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const qrOutput=document.getElementById("qrOutput");if(qrOutput)qrOutput.innerHTML="";const expirySortBtn=document.getElementById("toggleExpirySort");if(expirySortBtn)expirySortBtn.setAttribute("data-active","false");const storedPasscode=localStorage.getItem("encryptedPasscode");showScreen(storedPasscode?"loginView":"registrationView")}function deleteQrCode(){const qrOutput=document.getElementById("qrOutput");const qrPlace=document.getElementById("hiddenQr");if(qrOutput)qrOutput.innerHTML="";if(qrOutput)qrPlace.style.display="none"}document.addEventListener("DOMContentLoaded",()=>{const resetButton=document.getElementById("resetAppButton");if(resetButton){resetButton.addEventListener("click",()=>{showConfirmModal("Are you sure you want to reset the entire app? This will delete all data.",()=>resetCompleteApp())})}});function showConfirmModal(message,onConfirm){const modal=document.getElementById("confirmationModal");const msg=document.getElementById("confirmationMessage");const yesBtn=document.getElementById("confirmYesBtn");const noBtn=document.getElementById("confirmNoBtn");msg.textContent=message;modal.classList.remove("hidden");const close=()=>{modal.classList.add("hidden");yesBtn.removeEventListener("click",confirmHandler);noBtn.removeEventListener("click",cancelHandler)};const confirmHandler=()=>{close();if(typeof onConfirm==="function")onConfirm()};const cancelHandler=()=>close();yesBtn.addEventListener("click",confirmHandler);noBtn.addEventListener("click",cancelHandler)}function resetCompleteApp(){localStorage.clear();if(typeof sessionKey!=="undefined")sessionKey="";document.querySelectorAll("input, textarea").forEach(el=>{if(el.type!=="checkbox"&&el.type!=="radio"){el.value=""}else{el.checked=false}});document.querySelectorAll(".modal, .modal-edit, .modal-confirm, .carrypass-modal").forEach(modal=>{modal.classList.add("hidden");modal.classList.remove("active");modal.style.display="none"});const backdrop=document.getElementById("modalBackdrop");if(backdrop)backdrop.classList.add("hidden");document.querySelectorAll(".modal-error").forEach(errBox=>{errBox.textContent="";errBox.classList.add("hidden");errBox.classList.remove("active")});["mainPassword","username","supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"].forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const savedList=document.getElementById("savedServicesList");if(savedList)savedList.innerHTML="";localStorage.clear();sessionStorage.clear();location.reload();showScreen("registrationView");showModalAlert("✅ Application has been reset. You may now start fresh.")}document.getElementById("appViewLogout").addEventListener("click",switchOff);document.getElementById("adminEditViewLogout").addEventListener("click",switchOff);document.getElementById("memberPanelLogout").addEventListener("click",switchOff);document.getElementById("memberVaultLogout").addEventListener("click",switchOff);document.getElementById("adminSetupLogout").addEventListener("click",switchOff);document.getElementById("adminEditorLoginLogout").addEventListener("click",switchOff);document.getElementById("adminBootstrapLogout").addEventListener("click",switchOff);window.addEventListener("load",checkSessionTimeout);window.addEventListener("popstate",checkSessionTimeout);window.addEventListener("hashchange",checkSessionTimeout);document.addEventListener("DOMContentLoaded",function(){lucide.createIcons()});document.addEventListener("DOMContentLoaded",()=>{const hasPasscode=!!localStorage.getItem("encryptedPasscode");if(hasPasscode){showScreen("loginView")}else{showScreen("registrationView")}});function sanitizeServiceNameStringForBase64(input){let normalized=input.normalize("NFD").replace(/[\u0300-\u036f]/g,"");const manualMap={"ß":"ss","ø":"o","Ø":"O","æ":"ae","Æ":"AE","œ":"oe","Œ":"OE","ð":"d","Ð":"D","þ":"th","Þ":"Th"};normalized=normalized.replace(/[^\x00-\x7F]/g,char=>manualMap[char]||"");return normalized.replace(/[^a-zA-Z0-9]/g,"").trim().toLowerCase()}function sanitizeStringForBase64(input){let normalized=input.normalize("NFD").replace(/[\u0300-\u036f]/g,"");const manualMap={"ß":"ss","ø":"o","Ø":"O","æ":"ae","Æ":"AE","œ":"oe","Œ":"OE","ð":"d","Ð":"D","þ":"th","Þ":"Th"};normalized=normalized.replace(/[^\x00-\x7F]/g,char=>manualMap[char]||"");return normalized.replace(/[^a-zA-Z0-9\s?!);/.,:'"@#$%^&*_\-+=<>[\]{}|\\~`]/g,"")}document.addEventListener("DOMContentLoaded",()=>{const webAddressInput=document.getElementById("webAddress");if(webAddressInput){webAddressInput.addEventListener("input",()=>{const sanitized=sanitizeServiceNameStringForBase64(webAddressInput.value);if(webAddressInput.value!==sanitized){webAddressInput.value=sanitized;webAddressInput.classList.add("input-flash");setTimeout(()=>{webAddressInput.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const webAddressInputAdmin=document.getElementById("webAddressAdmin");if(webAddressInputAdmin){webAddressInputAdmin.addEventListener("input",()=>{const sanitized=sanitizeServiceNameStringForBase64(webAddressInputAdmin.value);if(webAddressInputAdmin.value!==sanitized){webAddressInputAdmin.value=sanitized;webAddressInputAdmin.classList.add("input-flash");setTimeout(()=>{webAddressInputAdmin.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const memberIdInput=document.getElementById("memberId");if(memberIdInput){memberIdInput.addEventListener("input",()=>{const sanitized=sanitizeServiceNameStringForBase64(memberIdInput.value);if(memberIdInput.value!==sanitized){memberIdInput.value=sanitized;memberIdInput.classList.add("input-flash");setTimeout(()=>{memberIdInput.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passwordApp=document.getElementById("password");if(passwordApp){passwordApp.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passwordApp.value);if(passwordApp.value!==sanitized){passwordApp.value=sanitized;passwordApp.classList.add("input-flash");setTimeout(()=>{passwordApp.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passwordAdmin=document.getElementById("passwordAdmin");if(passwordAdmin){passwordAdmin.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passwordAdmin.value);if(passwordAdmin.value!==sanitized){passwordAdmin.value=sanitized;passwordAdmin.classList.add("input-flash");setTimeout(()=>{passwordAdmin.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passwordMember=document.getElementById("memberFinalizeMasterPassword");if(passwordMember){passwordMember.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passwordMember.value);if(passwordMember.value!==sanitized){passwordMember.value=sanitized;passwordMember.classList.add("input-flash");setTimeout(()=>{passwordMember.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeRegisterSanit=document.getElementById("passCodeInputRegister");if(passCodeRegisterSanit){passCodeRegisterSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeRegisterSanit.value);if(passCodeRegisterSanit.value!==sanitized){passCodeRegisterSanit.value=sanitized;passCodeRegisterSanit.classList.add("input-flash");setTimeout(()=>{passCodeRegisterSanit.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeSanit=document.getElementById("passCodeInput");if(passCodeSanit){passCodeSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeSanit.value);if(passCodeSanit.value!==sanitized){passCodeSanit.value=sanitized;passCodeSanit.classList.add("input-flash");setTimeout(()=>{passCodeSanit.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeEditorSanit=document.getElementById("adminPasswordEditorInput");if(passCodeEditorSanit){passCodeEditorSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeEditorSanit.value);if(passCodeEditorSanit.value!==sanitized){passCodeEditorSanit.value=sanitized;passCodeEditorSanit.classList.add("input-flash");setTimeout(()=>{passCodeEditorSanit.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeMemberSanit=document.getElementById("memberPassword");if(passCodeMemberSanit){passCodeMemberSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeMemberSanit.value);if(passCodeMemberSanit.value!==sanitized){passCodeMemberSanit.value=sanitized;passCodeMemberSanit.classList.add("input-flash");setTimeout(()=>{passCodeMemberSanit.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeExportSanit=document.getElementById("adminExportPassword");if(passCodeExportSanit){passCodeExportSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeExportSanit.value);if(passCodeExportSanit.value!==sanitized){passCodeExportSanit.value=sanitized;passCodeExportSanit.classList.add("input-flash");setTimeout(()=>{passCodeExportSanit.classList.remove("input-flash")},400)}})}});document.addEventListener("DOMContentLoaded",()=>{const passCodeMemberFinalizeSanit=document.getElementById("memberFinalizeMasterPassword");if(passCodeMemberFinalizeSanit){passCodeMemberFinalizeSanit.addEventListener("input",()=>{const sanitized=sanitizeStringForBase64(passCodeMemberFinalizeSanit.value);if(passCodeMemberFinalizeSanit.value!==sanitized){passCodeMemberFinalizeSanit.value=sanitized;passCodeMemberFinalizeSanit.classList.add("input-flash");setTimeout(()=>{passCodeMemberFinalizeSanit.classList.remove("input-flash")},400)}})}});function showSmooth(element){if(!element)return;resetTimer();element.classList.add("visible")}function hideSmooth(element){if(!element)return;resetTimer();element.classList.remove("visible")}function toggleSliderState(sliderId,buttonId){const slider=document.getElementById(sliderId);const ball=document.getElementById(buttonId);var settingsState=document.getElementById("settings");resetTimer();if(slider.classList.contains("active")){slider.classList.remove("active");ball.classList.remove("active");if(buttonId=="btn1"){hideSmooth(settingsState)}}else{slider.classList.add("active");ball.classList.add("active");if(buttonId=="btn1"){showSmooth(settingsState)}}}document.getElementById("btn1").addEventListener("click",function(){toggleSliderState("slider1","btn1")});document.getElementById("btn2").addEventListener("click",function(){toggleSliderState("slider2","btn2")});function activateToggle(){const toggle1=document.getElementById("toggle1");toggle1.checked=true;const toggle2=document.getElementById("toggle2");toggle2.checked=true;const toggle3=document.getElementById("toggle3");toggle3.checked=false;const toggle4=document.getElementById("toggle4");toggle4.checked=true;const event=new Event("change");toggle1.dispatchEvent(event);toggle2.dispatchEvent(event);toggle3.dispatchEvent(event);toggle4.dispatchEvent(event);resetTimer()}document.addEventListener("DOMContentLoaded",event=>{activateToggle()});document.getElementById("iterationCount").addEventListener("input",function(){const value=this.value;if(value.length>5){this.value=value.slice(0,5)}});document.getElementById("length").addEventListener("input",function(){const value=this.value;if(value.length>3){this.value=value.slice(0,3)}});document.getElementById("iterationCount").addEventListener("focus",function(){this.value=""});document.getElementById("iterationCount").addEventListener("blur",function(){if(this.value===""){this.value="100"}});document.getElementById("length").addEventListener("focus",function(){this.value=""});document.getElementById("length").addEventListener("blur",function(){if(this.value===""){this.value="28"}});document.getElementById("iterationCount").addEventListener("input",function(){if(this.value==="0"){this.value=""}else if(this.value.startsWith("0")&&this.value.length>1){this.value=this.value.slice(1)}});document.getElementById("length").addEventListener("input",function(){if(this.value==="0"){this.value=""}else if(this.value.startsWith("0")&&this.value.length>1){this.value=this.value.slice(1)}});function normalizeServiceName(service){if(!service)return"";return service.trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\./,"")}async function collectInputData(){const button=document.getElementById("collectInput");const status=document.getElementById("generationStatus");const webAddressField=document.getElementById("webAddress");const passwordField=document.getElementById("password");if(!webAddressField.value.trim()){webAddressField.focus();return}if(!passwordField.value.trim()){passwordField.focus();return}if(passwordField.value.trim().length<12){showModalAlert("Master password must be at least 12 characters. For strong security, use 16 or more.");passwordField.focus();return}button.disabled=true;status.style.visibility="visible";const webAddressInput=document.getElementById("webAddress").value;const passwordInput=document.getElementById("password").value;const lengthInput=document.getElementById("length").value;const iterationCountInput=document.getElementById("iterationCount").value;resetTimer();const lettersChecked=document.getElementById("toggle1").checked;const numbersChecked=document.getElementById("toggle2").checked;const symbolsChecked=document.getElementById("toggle3").checked;const separatorChecked=document.getElementById("toggle4").checked;let charTypes={letters:lettersChecked,numbers:numbersChecked,symbols:symbolsChecked};const saveSliderActive=document.getElementById("slider2").classList.contains("active");if(saveSliderActive){const rawAddress=document.getElementById("webAddress").value.trim();const normalizedAddress=normalizeServiceName(rawAddress);const settings={webAddress:rawAddress,length:lengthInput,iterationCount:iterationCountInput,letters:lettersChecked,numbers:numbersChecked,symbols:symbolsChecked,separator:separatorChecked};await encryptSettings(normalizedAddress,settings);buildSavedServicesList();document.getElementById("slider2").classList.remove("active");document.getElementById("btn2").classList.remove("active")}clearAllPassword();setTimeout(()=>{generateDeterministicPasswordsWithAESCTR(webAddressInput,passwordInput,lengthInput,iterationCountInput,charTypes,separatorChecked);button.disabled=false;status.style.visibility="hidden"},10)}function formatKeyPass(bytes,length,charset,rules=[],input=""){let result="",has={};for(let i=0;i<bytes.words.length*4;i++){let byte=bytes.words[Math.floor(i/4)]>>24-i%4*8&255;let char=charset.charAt(byte%charset.length);result+=char;rules.forEach(rule=>{has[rule]||=new RegExp(rule).test(char)})}if(rules.length&&!rules.every(rule=>has[rule])){if(rules.includes("[a-zA-Z]")&&!has["[a-zA-Z]"])result=deterministicInsert(result,"g",input);if(rules.includes("[0-9]")&&!has["[0-9]"])result=deterministicInsert(result,"4",input);if(rules.includes("[!@#$%^&*()-_=+[]{}|;:,.<>?]")&&!has["[!@#$%^&*()-_=+[]{}|;:,.<>?]"])result=deterministicInsert(result,"!",input)}return result.slice(0,length)}const PASSWORDCHARSETS={upperAlpha:"ZJVEQSLBWRGNMYXDOCHIPATUKF",lowerAlpha:"pvjaqukxhyngorfizwmtlbdecs",numbers:"72940538615784216903",special:"!@#&$%*^()_+[]{}|;:,.<>?/"};function getEffectivePBKDF2Iterations(userInput){const parsed=parseInt(userInput);const input=isNaN(parsed)||parsed<1?1:parsed;let iterations;if(input>66666){iterations=Math.floor((1e5+input)/3)}else if(input>33333){iterations=Math.floor((5e4+input)/3)}else{iterations=Math.floor((2e4+input)/3)}return Math.max(1e3,iterations)}async function generateDeterministicPasswordsWithAESCTR(webAddress,masterPassword,length,iterationCount,charTypes,segmented=false){const supplementaryInputs=["mainPassword","supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive"];const normalizedService=normalizeServiceName(webAddress);let charset="";if(charTypes.letters)charset+=PASSWORDCHARSETS.upperAlpha+PASSWORDCHARSETS.lowerAlpha;if(charTypes.numbers)charset+=PASSWORDCHARSETS.numbers;if(charTypes.symbols)charset+=PASSWORDCHARSETS.special;if(!charset){showModalAlert("Please select at least one character type: Letters, Numbers, or Symbols.");return[]}const saltInputArgon=normalizedService+"::"+iterationCount+"::"+length;const argonSalt=(new TextEncoder).encode(saltInputArgon);const options=mapArgonOptions(iterationCount);const argonHash=await argon2.hash({pass:masterPassword,salt:argonSalt,...options,hashLen:32,raw:true});const argonEnhancer=Array.from(argonHash.hash).map(b=>b.toString(16).padStart(2,"0")).join("");const saltInput=normalizedService+"::"+iterationCount+"::"+length+"::"+argonEnhancer;const salt=CryptoJS.SHA256(saltInput).toString();const key=CryptoJS.PBKDF2(masterPassword,salt,{keySize:256/32,iterations:getEffectivePBKDF2Iterations(iterationCount),hasher:CryptoJS.algo.SHA256});for(let index=0;index<6;index++){let password="";let blockCounter=0;while(password.length<length){const counterIvHex=CryptoJS.SHA256(`pwgen::${normalizedService}::${index}::${blockCounter}`).toString().substring(0,32);const iv=CryptoJS.enc.Hex.parse(counterIvHex);const inputBlock=CryptoJS.enc.Hex.parse("00000000000000000000000000000000");const encrypted=CryptoJS.AES.encrypt(inputBlock,key,{mode:CryptoJS.mode.CTR,iv:iv,padding:CryptoJS.pad.NoPadding});const stream=encrypted.ciphertext.words;for(let i=0;i<stream.length*4&&password.length<length;i++){const word=stream[Math.floor(i/4)]>>>24-i%4*8;password+=charset.charAt(word%charset.length)}blockCounter++}if(segmented){password=segmentKey(password,7)}document.getElementById(supplementaryInputs[index]).value=password}const keyPass=document.getElementById("mainPassword").value;const generated=document.getElementById("generatedPassword");showSmooth(generated);generatePasswordAndTrigger(keyPass);generateUsername();document.getElementById("createdfor").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("password").disabled=true;document.getElementById("generationStatus").style.visibility="hidden";const dot=document.getElementById("dot");dot.style.backgroundColor="#e7f1ff";updateCounter();resetTimer()}function mapArgonOptions(iterationCountInput){const parsed=parseInt(iterationCountInput);const input=isNaN(parsed)?1:parsed;let timeCost=5;let memoryCost=65536;if(input>66666){timeCost=15;memoryCost=196608}else if(input>33333){timeCost=11;memoryCost=131072}const parallelism=1;return{timeCost:timeCost,memoryCost:memoryCost,parallelism:parallelism,type:argon2.ArgonType.Argon2id}}async function generateDeterministicPasswordsWithArgon2(webAddress,masterPassword,length,iterationCount,charTypes,segmented=false){const supplementaryInputs=["supplementaryone","supplementarytwo","supplementarythree","supplementaryfour","supplementaryfive","mainPassword"];const normalizedService=normalizeServiceName(webAddress);let charset="";if(charTypes.letters)charset+=PASSWORDCHARSETS.upperAlpha+PASSWORDCHARSETS.lowerAlpha;if(charTypes.numbers)charset+=PASSWORDCHARSETS.numbers;if(charTypes.symbols)charset+=PASSWORDCHARSETS.special;if(!charset){showModalAlert("Please select at least one character type: Letters, Numbers, or Symbols.");return[]}const saltInput=normalizedService+"::"+iterationCount+"::"+length;const salt=(new TextEncoder).encode(saltInput);const options=mapArgonOptions(iterationCount);const hash=await argon2.hash({pass:masterPassword,salt:salt,...options,hashLen:32,raw:true});const key=CryptoJS.lib.WordArray.create(hash);for(let index=0;index<6;index++){let password="";let blockCounter=0;while(password.length<length){const counterIvHex=CryptoJS.SHA256(`pwgen::${normalizedService}::${index}::${blockCounter}`).toString().substring(0,32);const iv=CryptoJS.enc.Hex.parse(counterIvHex);const inputBlock=CryptoJS.enc.Hex.parse("00000000000000000000000000000000");const encrypted=CryptoJS.AES.encrypt(inputBlock,key,{mode:CryptoJS.mode.CTR,iv:iv,padding:CryptoJS.pad.NoPadding});const stream=encrypted.ciphertext.words;for(let i=0;i<stream.length*4&&password.length<length;i++){const word=stream[Math.floor(i/4)]>>>24-i%4*8;password+=charset.charAt(word%charset.length)}blockCounter++}if(segmented){password=segmentKey(password,7)}document.getElementById(supplementaryInputs[index]).value=password}const keyPass=document.getElementById("mainPassword").value;const generated=document.getElementById("generatedPassword");showSmooth(generated);generatePasswordAndTrigger(keyPass);generateUsername();console.log("ARGON2 WORKS!");document.getElementById("createdfor").innerHTML="for <b>"+webAddress+"</b>";document.getElementById("webAddress").value="";document.getElementById("password").value="";document.getElementById("password").disabled=true;document.getElementById("generationStatus").style.visibility="hidden";const dot=document.getElementById("dot");dot.style.backgroundColor="#e7f1ff";updateCounter();resetTimer()}document.addEventListener("DOMContentLoaded",()=>{const webAddress=document.getElementById("webAddress");const password=document.getElementById("password");if(!webAddress||!password)return;webAddress.addEventListener("input",()=>{if(webAddress.value.trim().length>0){password.disabled=false}else{password.disabled=true;password.value=""}})});document.addEventListener("DOMContentLoaded",()=>{const toggle1=document.getElementById("toggle1");const toggle2=document.getElementById("toggle2");const toggle3=document.getElementById("toggle3");const trackedToggles=[toggle1,toggle2,toggle3];trackedToggles.forEach(toggle=>{toggle.addEventListener("change",()=>{const checkedCount=trackedToggles.filter(t=>t.checked).length;if(checkedCount===0){toggle.checked=true;const container=toggle.closest(".toggle-container");if(container){container.classList.add("bounce");setTimeout(()=>{container.classList.remove("bounce")},300)}}})})});document.getElementById("displayAdditional").addEventListener("click",function(){const explanation=document.getElementById("additionalPasswords");if(!explanation)return;if(explanation.classList.contains("visible")){hideSmooth(explanation)}else{showSmooth(explanation)}});function buildSavedServicesList(){const listContainer=document.getElementById("savedServicesList");listContainer.innerHTML="";for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.startsWith("encryptedSettings_")){const serviceName=key.replace("encryptedSettings_","");const li=document.createElement("li");li.style.display="flex";li.style.alignItems="center";li.style.justifyContent="space-between";li.style.marginBottom="0.5rem";const link=document.createElement("a");link.href="#toggleSavedServices";link.textContent=serviceName;link.style.marginRight="1rem";link.style.color="#1E003B";link.style.textDecoration="none";link.style.flexGrow="1";link.addEventListener("click",e=>{e.preventDefault();document.getElementById("webAddress").value=serviceName;const passwordField=document.getElementById("password");if(passwordField){passwordField.disabled=false}document.getElementById("webAddress").dispatchEvent(new Event("blur"));const panel=document.getElementById("savedServicesPanel");if(panel){panel.classList.remove("open")}});const trashWrapper=document.createElement("button");trashWrapper.style.background="none";trashWrapper.style.border="none";trashWrapper.style.cursor="pointer";trashWrapper.style.padding="0";trashWrapper.style.marginLeft="0.5rem";trashWrapper.style.display="flex";trashWrapper.style.alignItems="center";trashWrapper.setAttribute("aria-label","Delete service");const trashIcon=document.createElement("i");trashIcon.setAttribute("data-lucide","trash-2");trashIcon.style.width="20px";trashIcon.style.height="20px";trashIcon.style.color="#842029";trashWrapper.appendChild(trashIcon);trashWrapper.addEventListener("click",event=>{event.stopPropagation();event.preventDefault();showConfirmation(`Delete stored settings for ${serviceName} ?`,confirmed=>{if(confirmed){localStorage.removeItem(`encryptedSettings_${serviceName}`);buildSavedServicesList();const manageButton=document.getElementById("toggleSavedServices");if(manageButton){manageButton.classList.add("import-delete-flash");setTimeout(()=>{manageButton.classList.remove("import-delete-flash")},1e3)}}})});li.appendChild(link);li.appendChild(trashWrapper);listContainer.appendChild(li)}}if(typeof lucide!=="undefined"){lucide.createIcons()}}let pendingDeleteService=null;function showDeleteModal(serviceName){const modal=document.getElementById("confirmationModal");const modalMessage=document.getElementById("confirmationMessage");pendingDeleteService=serviceName;modalMessage.innerHTML=`
      Delete stored settings for <strong>${serviceName}</strong>?
      // <div style="margin-top: 1.5rem;">
      //   <button id="confirmDeleteBtn" class="btn strong" style="margin-right: 1rem;">Delete</button>
      //   <button id="cancelDeleteBtn" class="btn secondary">Cancel</button>
      // </div>
    `;modal.style.display="block";document.getElementById("confirmDeleteBtn").addEventListener("click",()=>{if(pendingDeleteService){localStorage.removeItem(`encryptedSettings_${pendingDeleteService}`);pendingDeleteService=null;buildSavedServicesList();modal.style.display="none"}});document.getElementById("cancelDeleteBtn").addEventListener("click",()=>{pendingDeleteService=null;modal.style.display="none"});const closeBtn=modal.querySelector(".close");if(closeBtn){closeBtn.onclick=()=>{pendingDeleteService=null;modal.style.display="none"}}}document.getElementById("savedServicesSearch").addEventListener("input",function(){const filter=this.value.toLowerCase();const listItems=document.querySelectorAll("#savedServicesList li");listItems.forEach(li=>{const text=li.querySelector("a")?.textContent.toLowerCase()||"";if(text.includes(filter)){li.style.display="flex"}else{li.style.display="none"}})});document.addEventListener("DOMContentLoaded",()=>{const toggleButton=document.getElementById("toggleSavedServices");const panel=document.getElementById("savedServicesPanel");if(!toggleButton||!panel)return;toggleButton.addEventListener("click",()=>{panel.classList.toggle("open")})});async function deriveKeyFromPasscode(passcode,salt){const encoder=new TextEncoder;const passkey=await crypto.subtle.importKey("raw",encoder.encode(passcode),"PBKDF2",false,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-256"},passkey,{name:"AES-GCM",length:256},false,["encrypt","decrypt"])}async function encryptPasswordCpsData(plaintext,passcode){resetTimer();const encoder=new TextEncoder;const data=encoder.encode(plaintext);const salt=crypto.getRandomValues(new Uint8Array(16));const iv=crypto.getRandomValues(new Uint8Array(12));const key=await deriveKeyFromPasscode(passcode,salt);const ciphertext=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,data);const encryptedBlob=new Uint8Array(salt.byteLength+iv.byteLength+ciphertext.byteLength);encryptedBlob.set(salt,0);encryptedBlob.set(iv,salt.byteLength);encryptedBlob.set(new Uint8Array(ciphertext),salt.byteLength+iv.byteLength);return encryptedBlob}async function decryptPasswordCpsData(encryptedBlob,passcode){try{const salt=encryptedBlob.slice(0,16);const iv=encryptedBlob.slice(16,28);const ciphertext=encryptedBlob.slice(28);const key=await deriveKeyFromPasscode(passcode,salt);const plaintextBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,ciphertext);resetTimer();const decoder=new TextDecoder;return decoder.decode(plaintextBuffer)}catch(err){console.error("Decryption failed:",err.name,err.message||err);throw new Error("Decryption failed — likely due to passcode mismatch or corrupted file.")}}function openCarryPasscodeModal(title="Enter Passcode"){const modal=document.getElementById("exportImportModal");const modalTitle=document.getElementById("exportImportModalTitle");const input=document.getElementById("exportImportModalInput");const okBtn=document.getElementById("exportImportModalOK");const cancelBtn=document.getElementById("exportImportModalCancel");const errorBox=document.getElementById("exportImportModalError");modalTitle.textContent=title;modal.classList.remove("hidden");modal.classList.add("active");input.value="";input.focus();errorBox.textContent="";errorBox.classList.remove("active");errorBox.classList.add("hidden");let resolvePass,rejectPass;const passPromise=new Promise((resolve,reject)=>{resolvePass=resolve;rejectPass=reject});function closeModal(){modal.classList.remove("active");modal.classList.add("hidden");okBtn.removeEventListener("click",okHandler);cancelBtn.removeEventListener("click",cancelHandler);input.removeEventListener("keydown",keyHandler)}function okHandler(){const passcode=input.value.trim();resolvePass(passcode)}function cancelHandler(){closeModal();rejectPass(new Error("User cancelled"))}function keyHandler(e){if(e.key==="Enter")okHandler();if(e.key==="Escape")cancelHandler()}okBtn.addEventListener("click",okHandler);cancelBtn.addEventListener("click",cancelHandler);input.addEventListener("keydown",keyHandler);function showError(message){errorBox.textContent=message;errorBox.classList.remove("hidden");errorBox.classList.add("active");errorBox.classList.remove("shake");void errorBox.offsetWidth;errorBox.classList.add("shake")}return{passPromise:passPromise,showError:showError,close:closeModal}}async function exportEncryptedSettings(passcode){const exportData={};for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.startsWith("encryptedSettings_")){exportData[key]=JSON.parse(localStorage.getItem(key))}}resetTimer();const jsonData=JSON.stringify(exportData);const encryptedBlob=await encryptPasswordCpsData(jsonData,passcode);const blob=new Blob([encryptedBlob],{type:"application/octet-stream"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="carrypass-encrypted-settings.cps";document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}function showError(message){errorBox.textContent=message;errorBox.classList.remove("hidden");errorBox.classList.add("active");errorBox.classList.remove("shake");void errorBox.offsetWidth;errorBox.classList.add("shake")}async function tryUnlockEncryptedVaultFile(file){while(true){const{passPromise,showError,close}=openCarryPasscodeModal("Enter the password to import settings");try{const passcode=await passPromise;await importEncryptedSettings(file,passcode);close();break}catch(err){if(err.message==="User cancelled")break;showError("Wrong passcode, please try again!");await new Promise(resolve=>setTimeout(resolve,2e3))}}}async function importEncryptedSettings(file,passcode){const arrayBuffer=await file.arrayBuffer();const encryptedBlob=new Uint8Array(arrayBuffer);const decryptedText=await decryptPasswordCpsData(encryptedBlob,passcode);const importedData=JSON.parse(decryptedText);for(const[key,value]of Object.entries(importedData)){if(key.startsWith("encryptedSettings_")){localStorage.setItem(key,JSON.stringify(value))}}buildSavedServicesList();resetTimer();const manageButton=document.getElementById("toggleSavedServices");if(manageButton){manageButton.classList.add("import-success-flash");setTimeout(()=>{manageButton.classList.remove("import-success-flash")},1200)}}function triggerImportEncryptedSettings(file){const modal=document.getElementById("exportModal");(async()=>{try{while(true){try{const passcode=await openCarryPasscodeModal("Enter the password to import settings");await importEncryptedSettings(file,passcode);modal.closeModal();break}catch(err){if(err.message==="User cancelled")break;if(modal&&modal.showError){modal.showError("Wrong passcode, try again!")}}}}catch{}})()}document.addEventListener("DOMContentLoaded",()=>{const exportButton=document.getElementById("exportSettingsButton");if(exportButton){exportButton.addEventListener("click",async()=>{const{passPromise,close,showError}=openCarryPasscodeModal("Enter a password to export settings");try{const passcode=await passPromise;await exportEncryptedSettings(passcode);close()}catch(err){if(err.message==="User cancelled")return;showError("Export failed. Please try again.")}})}const importButton=document.getElementById("importSettingsButton");if(importButton){importButton.addEventListener("click",()=>{const fileInput=document.createElement("input");fileInput.type="file";fileInput.accept=".cps";fileInput.onchange=async e=>{const file=e.target.files[0];if(file){await tryUnlockEncryptedVaultFile(file)}};fileInput.click()})}});async function deriveAESKey(strongPassword,salt){const enc=(new TextEncoder).encode(strongPassword);const keyMaterial=await crypto.subtle.importKey("raw",enc,"PBKDF2",false,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:1e5,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt","decrypt"])}async function encryptAESGCM(plaintext,key,iv){const enc=(new TextEncoder).encode(plaintext);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,enc);return btoa(String.fromCharCode(...new Uint8Array(encrypted)))}async function decryptAESGCM(ciphertext,key,iv){const data=Uint8Array.from(atob(ciphertext),c=>c.charCodeAt(0));const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,data);return(new TextDecoder).decode(decrypted)}function parseAccessSettingsString(settingsStr){const flags=settingsStr.slice(0,4).toUpperCase();const rest=settingsStr.slice(4);const webAddressMatch=rest.match(/^[A-Z]+/i);if(!webAddressMatch)throw new Error("Invalid access settings string");const webAddress=webAddressMatch[0];const numericPart=rest.slice(webAddress.length);const length=parseInt(numericPart.slice(0,2),10);const iterationCount=parseInt(numericPart.slice(2),10);return{flags:flags,webAddress:webAddress,length:length,iterationCount:iterationCount,charTypes:{letters:flags[0]==="C",numbers:flags[1]==="C",symbols:flags[2]==="C"},separator:flags[3]==="C"}}async function generateStrongPasswordFromAccessSettings(accessSettings,masterPassword){const parsed=parseAccessSettingsString(accessSettings);return await generateDeterministicPassword(parsed.webAddress,masterPassword,parsed.length,parsed.iterationCount,parsed.charTypes,parsed.separator)}async function generateDeterministicPassword(webAddress,masterPassword,length,iterationCount,charTypes,separator){const charset=buildCharset(charTypes);const salt=webAddress+"::"+iterationCount;const keyMaterial=CryptoJS.PBKDF2(masterPassword+salt,salt,{keySize:length/4,iterations:iterationCount,hasher:CryptoJS.algo.SHA256});let password="";const words=keyMaterial.words;for(let i=0;i<length;i++){const byte=words[Math.floor(i/4)]>>24-i%4*8&255;password+=charset.charAt(byte%charset.length)}return separator?password.match(/.{1,7}/g).join("-"):password}async function exportVault(adminAccess,adminPassword,flavour,adminContent,membersContent){const strongAdminPassword=await generateStrongPasswordFromAccessSettings(adminAccess,adminPassword);const{salt:adminSalt,iv:adminIV}=await generatePseudoPadWithFlavor(adminAccess,strongAdminPassword,flavour);const adminKey=await deriveAESKey(strongAdminPassword,adminSalt);const adminEncrypted=await encryptAESGCM(JSON.stringify(adminContent),adminKey,adminIV);const membersEncrypted={};for(const[memberId,memberData]of Object.entries(membersContent)){const strongMemberPassword=await generateStrongPasswordFromAccessSettings(memberData.access,memberData.password);const{salt:memberSalt,iv:memberIV}=await generatePseudoPadWithFlavor(memberData.access,strongMemberPassword,flavour);const memberKey=await deriveAESKey(strongMemberPassword,memberSalt);membersEncrypted[memberId]=await encryptAESGCM(JSON.stringify(memberData.payload),memberKey,memberIV)}const vault={vault_metadata:{display_name:"Team CarryPass Vault",version:"1.0",flavour:flavour,expiry:"2025-12-31"},admin_encrypted:adminEncrypted,members:membersEncrypted};const blob=new Blob([JSON.stringify(vault,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="team-vault.json";a.click()}async function decryptAndLoadVaultFromFile(){try{const response=await fetch("/vault/team-vault.json");const vaultJson=await response.json();return vaultJson}catch(err){console.error("❗ Failed to load vault file:",err);showModalAlert("❗ Failed to load vault file. Check console for details.");throw err}}async function memberUnlockVault(){const memberAccess=document.getElementById("memberAccessInput").value.trim();const memberPassword=document.getElementById("memberPasswordInput").value.trim();const vaultResponse=await fetch("/vault/team-vault.json");const vaultJson=await vaultResponse.json();const memberId=generateMemberIdFromAccess(memberAccess);const memberBlock=vaultJson.members_section[memberId];if(!memberBlock)throw new Error("❗ Member block not found.");const strongMemberPassword=await generateStrongPasswordFromAccessSettings(memberAccess,memberPassword);const{salt,iv}=await generatePseudoPad(memberAccess,strongMemberPassword,vaultJson.vault_metadata.flavour);const memberKey=await deriveAESKey(strongMemberPassword,salt);const decrypted=await decryptAESGCM(memberBlock,memberKey,iv);const memberData=JSON.parse(decrypted);renderMemberVault(memberData);showScreen("memberPanel")}function generateMemberIdFromAccess(accessSettings){return CryptoJS.SHA256(accessSettings).toString().slice(0,12)}function renderMemberVault(decryptedVault){const container1=document.getElementById("memberVaultContent1");const container2=document.getElementById("memberVaultContent2");container1.innerHTML="";container2.innerHTML="";let counter=0;Object.entries(decryptedVault.team_data||{}).forEach(([teamId,team])=>{const targetContainer=counter%2===0?container1:container2;counter++;const teamBlock=document.createElement("div");teamBlock.className="team-section card";teamBlock.innerHTML=`<h4>Team: ${team.name}</h4>`;const creds=team.credentials||[];if(creds.length===0){teamBlock.innerHTML+="<p>No credentials in this team.</p>"}else{creds.forEach(cred=>{const credBlock=document.createElement("div");credBlock.className="credential-block";credBlock.innerHTML=`
          <strong>${cred.label}</strong><br>
          <div style="width: 100%; text-align: left;">
          <label style="margin-right:auto">Username</label>
          </div>
          <div class="input-group">
            <input id="credBlockUsername__${cred.username}" readonly value="${cred.username}">
            <button data-password-id="credBlockUsername__${cred.username}" type="button" class="btn outline-gold" name="credBlockUsername__${cred.username}">Copy</button>
            <span id="copySuccessIcon-credBlockUsername__${cred.username}" class="icon" style="display: none;"></span>
          </div>
          <div style="width: 100%; text-align: left;">
          <label style="margin-right:auto">Password</label>
          </div>
          <div class="input-group">
            <input id="credBlockPassword__${cred.password}" readonly type="password" value="${cred.password}">
            <button type="button" id="credBlockShow__${cred.password}" class="btn secondary-outline" name="credBlockPassword__${cred.password}">Show</button>
            <button data-password-id="credBlockPassword__${cred.password}" type="button" class="btn outline-gold" name="credBlockPassword__${cred.password}">Copy</button>
            <span id="copySuccessIcon-credBlockPassword__${cred.password}" class="icon" style="display: none;"></span>
          </div>
          <div style="width: 100%; text-align: left;">
          <label style="margin-right:auto">Service URL</label>
          </div>
          <div class="input-group">
            <input readonly value="${cred.url}">
            <button type="button" class="btn secondary-outline open-url-button" style="margin-left:auto;" data-url="${cred.url}">Open</button>
          </div>
          <div style="width: 100%; text-align: left;">
          <label style="margin-right:auto">Notes</label>
          </div>
          <textarea readonly>${cred.notes||""}</textarea>
        `;teamBlock.appendChild(credBlock)})}targetContainer.appendChild(teamBlock)})}let _finalizingMemberId=null;let _adminFinalizeData=null;function openAdminFinalizeModal(memberId){_finalizingMemberId=memberId;_adminFinalizeData=null;document.getElementById("adminFinalizeAccessSettings").value="";document.getElementById("adminFinalizeMasterPassword").value="";document.getElementById("adminFinalizeModal").style.display="block"}function closeAdminFinalizeModal(){document.getElementById("adminFinalizeModal").style.display="none";_finalizingMemberId=null}async function proceedToMemberFinalize(){const adminAccess=document.getElementById("adminFinalizeAccessSettings").value.trim();const adminPassword=document.getElementById("adminFinalizeMasterPassword").value.trim();if(!adminAccess||!adminPassword){showModalAlert("❗ Admin Access Settings and Master Password are required.");return}_adminFinalizeData={accessSettings:adminAccess,masterPassword:adminPassword};document.getElementById("adminFinalizeModal").style.display="none";document.getElementById("memberFinalizeAccessSettings").value="";document.getElementById("memberFinalizeMasterPassword").value="";document.getElementById("memberFinalizeModal").style.display="block"}function openMemberFinalizeModal(memberId){document.getElementById("memberFinalizeUsername").value=memberId;document.getElementById("memberFinalizeMasterPassword").value="";const modal=document.getElementById("memberFinalizeModal");modal.classList.add("active");modal.classList.remove("hidden")}function closeMemberFinalizeModal(){const modal=document.getElementById("memberFinalizeModal");modal.classList.add("hidden");modal.classList.remove("active");document.getElementById("memberFinalizeUsername").value="";document.getElementById("memberFinalizeMasterPassword").value="";document.getElementById("passwordStrengthBarMember").innerText="";document.getElementById("passwordStrengthTextMember").innerText="";document.getElementById("entropyTextMember").innerText=""}async function submitFinalizeEncryption(){const memberPassword=document.getElementById("memberFinalizeMasterPassword").value.trim();if(!memberPassword){showModalAlert("❗ Master Password is required.");return}try{const member=vault.members[_finalizingMemberId];if(!member)throw new Error("Member not found.");const adminKey=await generateStrongPasswordFromAccessSettings(_adminFinalizeData.accessSettings,_adminFinalizeData.masterPassword);const memberKey=await generateStrongPasswordFromAccessSettings(memberAccess,memberPassword);Object.keys(member.team_keys||{}).forEach(teamId=>{let team=vault.teams[teamId];if(!team)throw new Error(`Team ${teamId} not found.`);let rawTeamKey;if(team.admin_encrypted_key){rawTeamKey=CryptoJS.AES.decrypt(team.admin_encrypted_key,adminKey).toString(CryptoJS.enc.Utf8)}else{rawTeamKey=generateRandomTeamKey();team.admin_encrypted_key=CryptoJS.AES.encrypt(rawTeamKey,adminKey).toString()}const encryptedForMember=CryptoJS.AES.encrypt(rawTeamKey,memberKey).toString();member.team_keys[teamId]={data:encryptedForMember,pending:false}});member.vault_metadata.pending=false;member.password_hash=memberAccess;updateMembersList();updateAssignmentsUI();showModalAlert("✅ Member finalized successfully.");closeMemberFinalizeModal()}catch(err){console.error(err);showModalAlert("❗ Failed to finalize member.")}}function generateRandomTeamKey(length=32){const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let key="";for(let i=0;i<length;i++){key+=chars.charAt(Math.floor(Math.random()*chars.length))}return key}async function hashMasterPassword(password){const encoder=new TextEncoder;const data=encoder.encode(password);const hashBuffer=await crypto.subtle.digest("SHA-256",data);const hashArray=Array.from(new Uint8Array(hashBuffer));return hashArray.map(b=>b.toString(16).padStart(2,"0")).join("")}async function generatePseudoPadWithFlavor(accessSettings,strongPassword,variant="Vortex"){const base=accessSettings+strongPassword+variant;const hash=CryptoJS.SHA256(base).toString(CryptoJS.enc.Hex);const saltHex=hash.substring(0,32);const ivHex=hash.substring(32,56);const salt=hexToBytes(saltHex);const iv=hexToBytes(ivHex);const padText=hash+hash;const encoder=new TextEncoder;const upperCode=accessSettings.toUpperCase();const hashBuffer=await crypto.subtle.digest("SHA-512",encoder.encode(upperCode));const hashArr=Array.from(new Uint8Array(hashBuffer));function extract(offsetMod,len){const offset=hashArr.slice(0,4).reduce((acc,val)=>acc<<8|val,0)%(padText.length-len);return padText.slice(offset,offset+len)}let k1,totpSecret;if(variant.toLowerCase()==="shift5"){const shift=5;k1=extract(shift,16);totpSecret=extract(shift+20,32).replace(/[^A-Z2-7]/g,"A")}else if(variant.toLowerCase()==="pinwheel"){const pos=hashArr[10]%padText.length;let str="";for(let i=0;i<32;i++){str+=padText[(pos+i*17)%padText.length]}k1=extract(7,16);totpSecret=str.replace(/[^A-Z2-7]/g,"A")}else if(variant.toLowerCase()==="scatter"){let idx=hashArr[3];let s="";for(let i=0;i<32;i++){s+=padText[(idx+i*hashArr[(i+12)%hashArr.length])%padText.length]}k1=extract(3,16);totpSecret=s.replace(/[^A-Z2-7]/g,"A")}else if(variant.toLowerCase()==="vortex"){let secret="";let pos=hashArr[6]*19;for(let i=0;i<32;i++){pos=(pos*31+hashArr[i%hashArr.length])%padText.length;secret+=padText[pos]}k1=extract(1,16);totpSecret=secret.replace(/[^A-Z2-7]/g,"A")}else{k1=extract(0,16);let pos=hashArr[4]%(padText.length-32);let raw="";for(let i=0;i<32;i++){raw+=padText[pos%padText.length];pos+=hashArr[5+i%(hashArr.length-5)]%11+1}totpSecret=raw.toUpperCase().replace(/[^A-Z2-7]/g,"A")}return{salt:salt,iv:iv,k1:k1,totpSecret:totpSecret}}function hexToBytes(hex){const bytes=new Uint8Array(hex.length/2);for(let i=0;i<bytes.length;i++){bytes[i]=parseInt(hex.substr(i*2,2),16)}return bytes}async function finalizeMember(){let memberId=document.getElementById("memberFinalizeUsername").value;let memberPassword=document.getElementById("memberFinalizeMasterPassword").value;if(!memberPassword){showModalAlert("❗ Member password required.");return}if(!isPasswordStrongEnough(memberPassword)){showModalAlert("❗ Password entropy too low to proceed.");return}if(!vault||!vault.members)throw new Error("❗ Vault or members section not initialized");const member=vault.members[memberId];if(!member)throw new Error("❗ Member not found");const salt=crypto.getRandomValues(new Uint8Array(16));const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(memberPassword),{name:"PBKDF2"},false,["deriveBits","deriveKey"]);const derivedKey=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:3e5,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},true,["encrypt","decrypt"]);const exportedKey=await crypto.subtle.exportKey("raw",derivedKey);const derivedKeyBase64=arrayBufferToBase64(exportedKey);member.encrypted_vault.password_derived_key=derivedKeyBase64;member.vault_metadata.salt=arrayBufferToBase64(salt);member.vault_metadata.pending=false;const flavour="Vortex";const newTOTP=generateBase32Secret(20);const encryptedTOTP=await encryptData(newTOTP,memberId,memberPassword,flavour);member.encrypted_vault.totp=encryptedTOTP;generateQRCodeForMember(member.encrypted_vault.name,memberId,newTOTP);updateMembersList();updateAssignmentsUI();showModalAlert(`✅ Member finalized successfully.`);closeMemberFinalizeModal()}function arrayBufferToBase64(buffer){const bytes=new Uint8Array(buffer);let binary="";for(let b of bytes)binary+=String.fromCharCode(b);return btoa(binary)}function base64ToArrayBuffer(base64){try{if(!base64||typeof base64!=="string"){throw new Error("Input must be a base64 string")}const binary=atob(base64);const bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++){bytes[i]=binary.charCodeAt(i)}return bytes.buffer}catch(e){console.error("❗ base64ToArrayBuffer failed:",e);throw new Error("Invalid base64 input")}}async function finalizeMemberSubmit(){const memberAccess=document.getElementById("memberFinalizeAccessSettings").value.trim();const memberPassword=document.getElementById("memberFinalizeMasterPassword").value.trim();if(!memberAccess||!memberPassword){showModalAlert("❗ Member Access Settings and Master Password are required.");return}if(!_adminFinalizeData){showModalAlert("❗ Missing admin authorization step.");return}try{const member=vault.members[_finalizingMemberId];if(!member)throw new Error("Member not found.");await finalizeMemberEncryption(_finalizingMemberId,_adminFinalizeData.accessSettings,_adminFinalizeData.masterPassword,memberAccess,memberPassword);const flavour=vault.vault_metadata.flavour||"Vortex";member.pending=false;const newTOTP=generateBase32Secret(20);const encryptedTOTP=await encryptData(newTOTP,memberAccess,memberPassword,flavour);member.totp=encryptedTOTP;generateQRCodeForMember(member.name,memberAccess,newTOTP);updateMembersList();updateAssignmentsUI();showModalAlert(`✅ Member finalized successfully.`)}catch(e){console.error(e);showModalAlert("❗ Failed to finalize member.")}_adminFinalizeData=null;_finalizingMemberId=null;document.getElementById("memberFinalizeModal").style.display="none"}function showExportModal(){const modal=document.getElementById("exportVaultModal");modal.classList.remove("hidden");modal.classList.add("active")}function closeExportModal(){const modal=document.getElementById("exportVaultModal");const masterPassword=document.getElementById("adminExportPassword");const vaultExpiry=document.getElementById("vaultExpiry");const passwordStrengthBarAdmin=document.getElementById("passwordStrengthBarAdmin");const passwordStrengthTextAdmin=document.getElementById("passwordStrengthTextAdmin");const entropyTextAdmin=document.getElementById("entropyTextAdmin");masterPassword.value="";vaultExpiry.value="";passwordStrengthBarAdmin.innerText="";passwordStrengthTextAdmin.innerText="";entropyTextAdmin.innerText="";modal.classList.remove("active");modal.classList.add("hidden")}let _currentAssigningMemberId=null;function openAssignMemberToTeamModal(memberId){_currentAssigningMemberId=memberId;const member=vault.members[memberId];document.getElementById("assignMemberNameLabel").textContent=`Assign to: ${member.encrypted_vault.name}`;const teamSelect=document.getElementById("assignTeamSelect");teamSelect.innerHTML="";Object.entries(vault.teams).forEach(([teamId,team])=>{const option=document.createElement("option");option.value=teamId;option.textContent=team.encrypted_team.name;teamSelect.appendChild(option)});document.getElementById("assignMemberModal").classList.remove("hidden")}function closeAssignMemberModal(){document.getElementById("assignMemberModal").classList.add("hidden");_currentAssigningMemberId=null}function confirmAssignMemberToTeam(){const teamId=document.getElementById("assignTeamSelect").value;if(!_currentAssigningMemberId||!teamId){showModalAlert("❗ Please select a member and team.");return}assignMemberToTeamAdminTool(_currentAssigningMemberId,teamId);updateAssignmentsUI();closeAssignMemberModal()}async function assignMemberToTeamAdminTool(memberId,teamId){const member=vault.members[memberId];const team=vault.teams[teamId];if(!member||!team){console.error("❗ Invalid member or team.");return}if(!member.encrypted_vault.team_keys){member.encrypted_vault.team_keys={}}member.encrypted_vault.team_keys[teamId]={data:team.encrypted_team.password_derived_key}}async function createInitialVault(adminAccessSettings,adminMasterPassword){const outerKey=await generateCarryPassKey(adminAccessSettings,adminMasterPassword);const vault={vault_metadata:{created:(new Date).toISOString(),flavour:"Vortex",expiry:""},teams:{},members:{}};const encryptedVault=await encryptWithOuterKey(vault,outerKey);saveVaultToFile(encryptedVault)}function addTeam(vault,teamName){const teamId=generateId();const teamKey=generateRandomTeamKey();vault.teams[teamId]={id:teamId,name:teamName,teamKey:teamKey,credentials:[]}}function addCredentialToTeam(vault,teamId,label,url,username,password){const team=vault.teams[teamId];const encryptedCred=CryptoJS.AES.encrypt(JSON.stringify({label:label,url:url,username:username,password:password}),team.teamKey).toString();team.credentials.push(encryptedCred)}async function finalizeMemberEncryption(memberId,adminAccessSettings,adminMasterPassword,memberAccessSettings,memberMasterPassword){const adminKey=await generateStrongPasswordFromAccessSettings(adminAccessSettings,adminMasterPassword);const memberKey=await generateStrongPasswordFromAccessSettings(memberAccessSettings,memberMasterPassword);const combinedKey=CryptoJS.SHA256(adminKey+memberKey).toString();const memberIdentifier=CryptoJS.SHA256(memberAccessSettings).toString().substring(0,12);vault.members[memberId].combined_key_for_admin=combinedKey;vault.members[memberId].stored_identifier=memberIdentifier;const flavour=vault.vault_metadata.flavour||"Vortex";const{salt,iv}=await generatePseudoPad(memberAccessSettings,memberKey,flavour);const cryptoKey=await deriveAESKey(memberKey,salt);const memberMiniVault={name:vault.members[memberId].name,team_keys:vault.members[memberId].team_keys||{},totp:vault.members[memberId].totp||null};const encryptedMini=await encryptAESGCM(JSON.stringify(memberMiniVault),cryptoKey,iv);if(!vault.members_section)vault.members_section={};vault.members_section[memberIdentifier]=encryptedMini;vault.members[memberId].pending=false}async function generateCarryPassKey(accessSettings,masterPassword){const parsed=parseAccessSettingsString(accessSettings);const basePassword=await generateDeterministicPassword(parsed.webAddress,masterPassword,parsed.length,parsed.iterationCount,parsed.charTypes,parsed.separator);return CryptoJS.SHA256(accessSettings+basePassword).toString()}function encryptWithOuterKey(data,outerKey){const ciphertext=CryptoJS.AES.encrypt(JSON.stringify(data),outerKey).toString();return ciphertext}async function decryptWithOuterKey(encryptedText,outerKey){const plaintext=CryptoJS.AES.decrypt(encryptedText,outerKey).toString(CryptoJS.enc.Utf8);return JSON.parse(plaintext)}function generateId(){return Math.random().toString(36).substring(2,10)}function generateRandomTeamKey(){return CryptoJS.lib.WordArray.random(32).toString()}function saveVaultToFile(encryptedContent){const blob=new Blob([encryptedContent],{type:"application/json"});const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download="team-vault.json";link.click()}async function deriveCombinedKey(adminAccessSettings,adminPassword,memberAccessSettings,memberPassword){const adminDerived=await generateStrongPasswordFromAccessSettings(adminAccessSettings,adminPassword);const memberDerived=await generateStrongPasswordFromAccessSettings(memberAccessSettings,memberPassword);const combinedHash=CryptoJS.SHA256(adminDerived+memberDerived).toString();return combinedHash}function getOrCreateTeamKey(teamId){if(!vault.teams[teamId].team_key){vault.teams[teamId].team_key=CryptoJS.lib.WordArray.random(32).toString()}return vault.teams[teamId].team_key}let finalizeTargetMemberId=null;const VAULT_SYSTEM_KEY=CryptoJS.enc.Utf8.parse("CarryPassTemporaryKey123!");async function deriveKeyWithArgon2(password,salt){const passwordBytes=(new TextEncoder).encode(password);const saltBytes=(new TextEncoder).encode(salt);const keyMaterial=await crypto.subtle.importKey("raw",passwordBytes,{name:"PBKDF2"},false,["deriveBits","deriveKey"]);const derivedBits=await crypto.subtle.deriveBits({name:"PBKDF2",salt:saltBytes,iterations:1e5,hash:"SHA-256"},keyMaterial,256);return derivedBits}async function generatePseudoPad(accessSettings,strongPassword,variant="Vortex"){const base=accessSettings+strongPassword+variant;const hash=CryptoJS.SHA256(base).toString(CryptoJS.enc.Hex);const saltHex=hash.substring(0,32);const ivHex=hash.substring(32,32+24);return{salt:hexToBytes(saltHex),iv:hexToBytes(ivHex)}}function hexToBytes(hex){const bytes=new Uint8Array(hex.length/2);for(let i=0;i<bytes.length;i++){bytes[i]=parseInt(hex.substr(i*2,2),16)}return bytes}async function encryptData(contentText,accessSettings,masterPassword,variant="Vortex"){const{salt,iv}=await generatePseudoPad(accessSettings,masterPassword,variant);const keyRaw=await deriveKeyWithArgon2(masterPassword,salt);const key=await crypto.subtle.importKey("raw",keyRaw,{name:"AES-GCM"},false,["encrypt"]);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,(new TextEncoder).encode(contentText));return btoa(String.fromCharCode.apply(null,new Uint8Array(encrypted)))}function normalizeServiceName(service){if(!service)return"";return service.trim().toLowerCase().replace(/^https?:\/\//,"").replace(/^www\\./,"")}function buildCharset(charTypes){let charset="";if(charTypes.letters)charset+=PASSWORDCHARSETS.upperAlpha+PASSWORDCHARSETS.lowerAlpha;if(charTypes.numbers)charset+=PASSWORDCHARSETS.numbers;if(charTypes.symbols)charset+=PASSWORDCHARSETS.special;return charset}function generateNumbers(seed){const result=[];for(let i=0;i<6;i++){let hash=CryptoJS.SHA256(seed+i).toString();let num=parseInt(hash.substring(0,8),16);result.push(num)}return result}async function encryptWithGCM(plaintext,accessSettings,masterPassword,variant="Vortex"){const strongPassword=await generateStrongPasswordFromAccessSettings(accessSettings,masterPassword);const{salt,iv}=await generatePseudoPad(accessSettings,strongPassword,variant);const keyRaw=await deriveKeyWithArgon2(strongPassword,salt);const key=await crypto.subtle.importKey("raw",keyRaw,{name:"AES-GCM"},false,["encrypt"]);const encrypted=await crypto.subtle.encrypt({name:"AES-GCM",iv:iv},key,(new TextEncoder).encode(plaintext));return btoa(String.fromCharCode.apply(null,new Uint8Array(encrypted)))}function onAdminEntry(){resetTimer();checkVaultExistence()}function decryptTOTPSecret(encryptedBase64,accessKey){const decrypted=CryptoJS.AES.decrypt(encryptedBase64,accessKey);return decrypted.toString(CryptoJS.enc.Utf8)}function base32ToBytes(base32){const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let bits="";for(let i=0;i<base32.length;i++){const val=alphabet.indexOf(base32[i].toUpperCase());if(val===-1)continue;bits+=val.toString(2).padStart(5,"0")}const bytes=[];for(let i=0;i+8<=bits.length;i+=8){bytes.push(parseInt(bits.substr(i,8),2))}return bytes}function generateTOTP(secret){const epoch=Math.floor(Date.now()/1e3);let time=Math.floor(epoch/30);const key=base32ToBytes(secret);const timeBytes=new Uint8Array(8);for(let i=7;i>=0;i--){timeBytes[i]=time&255;time>>=8}const cryptoKey=new Uint8Array(key);const hmac=CryptoJS.HmacSHA1(CryptoJS.lib.WordArray.create(timeBytes),CryptoJS.lib.WordArray.create(cryptoKey));const h=hmac.toString(CryptoJS.enc.Hex);const offset=parseInt(h.substring(h.length-1),16);const binary=parseInt(h.substr(offset*2,8),16)&2147483647;return(binary%1e6).toString().padStart(6,"0")}async function loadAdminConfig(){try{const res=await fetch("/vault/admin-config.json");if(!res.ok)throw new Error("Admin config not found");const json=await res.json();adminConfig=json}catch(err){}}async function adminUnlockVault(){const adminAccess=document.getElementById("adminAccessInput").value.trim();const adminPassword=document.getElementById("adminPasswordInput").value.trim();const totpCode=document.getElementById("adminTOTPInput").value.trim();if(!adminAccess||!adminPassword){showModalAlert("❗ Access Settings and Master Password are required.");return}try{const vaultResponse=await fetch("/vault/team-vault.json");const vaultJson=await vaultResponse.json();const strongAdminPassword=await generateStrongPasswordFromAccessSettings(adminAccess,adminPassword);const{salt,iv}=await generatePseudoPad(adminAccess,strongAdminPassword,vaultJson.vault_metadata.flavour);const adminKey=await deriveAESKey(strongAdminPassword,salt);const encryptedAdminBuffer=Uint8Array.from(atob(vaultJson.encrypted_admin_section),c=>c.charCodeAt(0));const decrypted=await decryptAESGCM(encryptedAdminBuffer.buffer,adminKey,iv);const adminData=JSON.parse(decrypted);if(adminData.admin_totp){const decryptedTOTP=await decryptTOTPSecret(adminData.admin_totp,strongAdminPassword);const expected=generateTOTP(decryptedTOTP);if(totpCode!==expected)throw new Error("Invalid TOTP code for Admin vault")}vault={vault_metadata:vaultJson.vault_metadata,admin_data:adminData,team_blocks:vaultJson.team_blocks,members_section:vaultJson.members_section};updateAllUI();showScreen("adminPanel")}catch(error){try{const strongPassword=await generateStrongPasswordFromAccessSettings(adminAccess,adminPassword);const{salt,iv}=await generatePseudoPad(adminAccess,strongPassword,"Vortex");const aesKey=await deriveAESKey(strongPassword,salt);const decryptedTOTP=await decryptAESGCM(adminConfig.totp_encrypted_secret,aesKey,iv);const expectedCode=generateTOTP(decryptedTOTP);if(totpCode!==expectedCode){throw new Error("Invalid TOTP code")}showModalAlert("✅ Admin identity verified. You may now create the first vault.");vault={admin_vault_metadata:{created_at:(new Date).toISOString(),flavour:adminConfig.access_flavour||"Vortex",expiry:"",nonce:"",salt:"",checksum:""},admin:"",teams:{},members:{}};updateAllUI();showScreen("adminPanel");adminConfig=null}catch(setupError){console.error(setupError);showModalAlert("❗ Admin unlock failed. Check your inputs or TOTP code.")}}}async function decryptAndLoadVault(vaultJson,adminAccess,adminPassword,totpCode){const flavour=vaultJson.vault_metadata?.flavour||"Vortex";const strongAdminPassword=await generateStrongPasswordFromAccessSettings(adminAccess,adminPassword);const{salt,iv}=await generatePseudoPad(adminAccess,strongAdminPassword,flavour);const adminKey=await deriveAESKey(strongAdminPassword,salt);try{const encryptedData=atob(vaultJson.encrypted_admin_section);const encryptedBytes=Uint8Array.from(encryptedData,c=>c.charCodeAt(0));const decrypted=await decryptAESGCM(encryptedBytes,adminKey,iv);const adminData=JSON.parse(decrypted);if(adminData.admin_totp){const decryptedTOTP=await decryptTOTPSecret(adminData.admin_totp,strongAdminPassword);const expected=generateTOTP(decryptedTOTP);if(totpCode!==expected){throw new Error("Invalid TOTP code for Admin vault")}}vault={vault_metadata:vaultJson.vault_metadata,admin_data:adminData,team_blocks:vaultJson.team_blocks||{},members_section:vaultJson.members_section||{}};updateAllUI();showScreen("adminPanel")}catch(err){console.error("❗ Failed to decrypt and load vault:",err);showModalAlert("❗ Failed to decrypt and load vault. Check console for details.")}}function updateAllUI(){lucide.createIcons();updateTeamList();updateMembersList();updateAssignmentsUI();updateCredentialsList();updateVaultExpirationDisplay()}function updateVaultExpirationDisplay(){if(vault.adminMetadata?.expiry){const expiryField=document.getElementById("vaultExpirationDisplay");if(expiryField){expiryField.innerText=vault.adminMetadata.expiry}}}async function decryptWithGCM(encryptedBase64,accessSettings,masterPassword,variant="Vortex"){const strongPassword=await generateStrongPasswordFromAccessSettings(accessSettings,masterPassword);const{salt,iv}=await generatePseudoPad(accessSettings,strongPassword,variant);const keyRaw=await deriveKeyWithArgon2(strongPassword,salt);const key=await crypto.subtle.importKey("raw",keyRaw,{name:"AES-GCM"},false,["decrypt"]);try{const encryptedBytes=Uint8Array.from(atob(encryptedBase64),c=>c.charCodeAt(0));const decrypted=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},key,encryptedBytes);securelyEraseMemory();return(new TextDecoder).decode(decrypted)}catch(e){securelyEraseMemory();throw new Error("❌ Decryption failed")}}function showCreateTeamModal(){resetTimer();document.getElementById("teamModal").classList.remove("hidden")}function hideCreateTeamModal(){document.getElementById("newTeamName").value="";document.getElementById("teamModal").classList.add("hidden")}async function createTeam(){resetTimer();const name=document.getElementById("newTeamName").value.trim();if(!name)return showModalAlert("❗ Team name required.");const existingTeamByName=Object.values(vault.teams||{}).find(team=>team.encrypted_team.name.toLowerCase()===name.toLowerCase());if(existingTeamByName){showModalAlert("❗ A team with this name already exists.");return}let id;do{id=generateId()}while(vault.teams&&vault.teams[id]);let accessSettings=generateMemberAccessSettings();let password=generateStrongPasswordFromAccessSettings(accessSettings,name);const salt=crypto.getRandomValues(new Uint8Array(16));const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(password),{name:"PBKDF2"},false,["deriveBits","deriveKey"]);const derivedKey=await crypto.subtle.deriveKey({name:"PBKDF2",salt:salt,iterations:3e5,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},true,["encrypt","decrypt"]);const exportedKey=await crypto.subtle.exportKey("raw",derivedKey);const derivedKeyBase64=arrayBufferToBase64(exportedKey);vault.teams[id]={encrypted_team:{id:id,name:name,password_derived_key:"",credentials:[]},team_metadata:{created_at:(new Date).toISOString(),salt:"",checksum:""}};const team=vault.teams[id];team.encrypted_team.password_derived_key=derivedKeyBase64;team.team_metadata.salt=arrayBufferToBase64(salt);hideCreateTeamModal();updateTeamList();lucide.createIcons()}async function createEncryptedTeamBlock(teamId,teamName,teamCredentials){const teamKey=CryptoJS.lib.WordArray.random(32).toString();const flavour=vault.vault_metadata.flavour||"Vortex";const{salt,iv}=await generatePseudoPad(teamId,teamKey,flavour);const cryptoKey=await deriveAESKey(teamKey,salt);const encryptedTeamBlock=await encryptAESGCM(JSON.stringify({name:teamName,credentials:teamCredentials}),cryptoKey,iv);if(!vault.team_blocks)vault.team_blocks={};vault.team_blocks[teamId]=encryptedTeamBlock;if(!vault.teams)vault.teams={};vault.teams[teamId]={id:teamId,name:teamName,team_key:teamKey}}function updateTeamList(){const list=document.getElementById("teamsList");const search=document.getElementById("teamSearchInput").value.toLowerCase();list.innerHTML="";const sortedTeams=Object.entries(vault.teams||{}).sort(([,a],[,b])=>a.encrypted_team.name.localeCompare(b.encrypted_team.name));sortedTeams.forEach(([id,team])=>{if(!team.encrypted_team.name.toLowerCase().includes(search))return;const div=document.createElement("div");div.className="team-card compact-item input-group";div.innerHTML=`
        <b>${team.encrypted_team.name}</b>
        <button id="deleteTeamButton-${id}" type="button" class="btn outline-secondary" style="margin-left:auto; max-width: none; width: auto;"><i data-lucide="trash-2"></i></button>
      `;list.appendChild(div)});resetTimer();lucide.createIcons()}function deleteTeam(id){showConfirmation("Are you sure you want to delete this team?",confirmed=>{if(confirmed){delete vault.teams[id];Object.values(vault.members||{}).forEach(member=>{if(member.encrypted_vault&&member.encrypted_vault.team_keys&&member.encrypted_vault.team_keys[id]){delete member.encrypted_vault.team_keys[id]}});lucide.createIcons();updateTeamList();updateMembersList();updateAssignmentsUI();updateAssignmentsByTeamUI();updateCredentialsList();updateCredentialsByTeam();showModalAlert(`✅ Team deleted and assignments cleared.`)}})}function generateId(){return Math.random().toString(36).substring(2,10)}function showCreateMemberModal(){const modal=document.getElementById("createMemberModal");if(modal)modal.classList.remove("hidden")}function hideCreateMemberModal(){const modal=document.getElementById("createMemberModal");const memberName=document.getElementById("newMemberName");memberName.value="";if(modal)modal.classList.add("hidden")}async function createMember(){const nameInput=document.getElementById("newMemberName");const memberName=nameInput.value.trim();if(!memberName){showModalAlert("❗ Member name is required.");return}const existingMemberByName=Object.values(vault.members||{}).find(member=>member.encrypted_vault.name.toLowerCase()===memberName.toLowerCase());if(existingMemberByName){showModalAlert("❗ A member with this name already exists.");return}let memberId;do{memberId=generateId()}while(vault.members&&vault.members[memberId]);vault.members[memberId]={encrypted_vault:{id:memberId,name:memberName,password_derived_key:"",totp:"",team_keys:{}},vault_metadata:{pending:true,totp_required:"no",created_at:(new Date).toISOString(),expiry:"",salt:"",checksum:""}};const defaultExpiry=new Date;defaultExpiry.setFullYear(defaultExpiry.getFullYear()+1);vault.members[memberId].vault_metadata.expiry=defaultExpiry.toISOString().split("T")[0];resetTimer();hideCreateMemberModal();updateMembersList();showModalAlert(`✅ Member '${memberName}' created successfully.`);nameInput.value=""}function deleteMember(id){showConfirmation("Delete this member from all teams?",confirmed=>{if(confirmed){const member=vault.members?.[id];if(member&&member.encrypted_vault?.team_keys){Object.keys(member.encrypted_vault.team_keys).forEach(teamId=>{delete member.encrypted_vault.team_keys[teamId]})}delete vault.members[id];updateMembersList();updateAssignmentsUI();updateAssignmentsByTeamUI();resetTimer();showModalAlert(`✅ Member deleted and assignments removed.`)}})}function cancelFinalize(){const prompt=document.getElementById("passwordPrompt");if(prompt)prompt.remove();finalizeTargetMemberId=null}function generateBase32Secret(byteLength=20){const randomBytes=window.crypto.getRandomValues(new Uint8Array(byteLength));return bytesToBase32(randomBytes)}function bytesToBase32(bytes){const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let bits=0,value=0,output="";for(let i=0;i<bytes.length;i++){value=value<<8|bytes[i];bits+=8;while(bits>=5){output+=alphabet[value>>>bits-5&31];bits-=5}}if(bits>0){output+=alphabet[value<<5-bits&31]}return output}async function submitFinalizePassword(){const password=document.getElementById("finalizePasswordInput").value.trim();if(!password||!finalizeTargetMemberId)return;const member=vault.members[finalizeTargetMemberId];const accessSettings=member.access_qr;const flavour=vault.vault_metadata.flavour||"Vortex";Object.entries(member.team_keys).forEach(([teamId,entry])=>{if(entry.pending){const tempDecrypted=CryptoJS.AES.decrypt(entry.data,VAULT_SYSTEM_KEY).toString(CryptoJS.enc.Utf8);encryptData(tempDecrypted,accessSettings,password,flavour).then(newEncrypted=>{member.team_keys[teamId]={data:newEncrypted,pending:false}})}});member.pending=false;const newTOTP=generateBase32Secret(20);const encryptedTOTP=await encryptData(newTOTP,accessSettings,password,flavour);member.totp=encryptedTOTP;finalizeTargetMemberId=null;document.getElementById("passwordPrompt").classList.add("hidden");document.getElementById("finalizePasswordInput").value="";updateMembersList();updateAssignmentsUI();generateQRCodeForMember(member.name,accessSettings,newTOTP)}function showAssignMemberModal(){const memberSelect=document.getElementById("selectMember");const teamSelect=document.getElementById("selectTeam");memberSelect.innerHTML="";teamSelect.innerHTML="";Object.entries(vault.members||{}).forEach(([id,member])=>{const option=document.createElement("option");option.value=id;option.textContent=member.name;memberSelect.appendChild(option)});Object.entries(vault.teams||{}).forEach(([id,team])=>{const option=document.createElement("option");option.value=id;option.textContent=team.name;teamSelect.appendChild(option)});document.getElementById("assignMemberModal").classList.remove("hidden");resetTimer()}function hideAssignMemberModal(){resetTimer();document.getElementById("assignMemberModal").classList.add("hidden")}function assignMemberToTeam(){const memberId=document.getElementById("selectMember").value;const teamId=document.getElementById("selectTeam").value;if(!memberId||!teamId)return showModalAlert("Select a member and a team.");const member=vault.members[memberId];const team=vault.teams[teamId];if(!member.team_keys)member.team_keys={};if(!member.team_keys[teamId]){member.team_keys[teamId]={data:"",pending:true}}if(!team.credentials)team.credentials=[];hideAssignMemberModal();updateAssignmentsUI();updateMembersList()}function deleteAssignment(memberId,teamId){const member=vault.members?.[memberId];if(!member||!member.team_keys?.[teamId])return;showConfirmation(`Remove ${member.name} from ${vault.teams?.[teamId]?.name||teamId}?`,confirmed=>{if(confirmed){delete member.team_keys[teamId];updateAssignmentsUI();updateMembersList()}})}function updateAssignmentsUI(){const list=document.getElementById("assignmentsList");const search=assignmentFilter.toLowerCase();list.innerHTML="";let hasAssignments=false;Object.entries(vault.members||{}).forEach(([memberId,member])=>{const encryptedMap=member.encrypted_vault.team_keys||{};const assignedTeamIds=Object.keys(encryptedMap);if(!assignedTeamIds.length)return;if(search&&!member.encrypted_vault.name.toLowerCase().includes(search))return;const div=document.createElement("div");div.className="member-card";let teamListHtml=assignedTeamIds.map(tid=>{const teamName=vault.teams[tid]?.encrypted_team.name||"(Unknown)";return`
        <span class="team-chip">
          ${teamName}
          <button id="removeMember-${memberId}-${tid}" class="icon-button" type="button">
            <i data-lucide="square-arrow-out-up-right" style="color: #1E003B;"></i>
          </button>
        </span>
      `}).join(" ");div.innerHTML=`
      <b>${member.encrypted_vault.name}</b><br>
      Teams: ${teamListHtml}
    `;list.appendChild(div);hasAssignments=true});if(!hasAssignments){list.innerHTML=`<em>No assignments yet.</em>`}resetTimer();lucide.createIcons()}function updateAssignmentsByTeamUI(){const list=document.getElementById("assignmentsList");const search=assignmentFilter.toLowerCase();list.innerHTML="";let hasAssignments=false;Object.entries(vault.members||{}).forEach(([memberId,member])=>{const encryptedMap=member.encrypted_vault.team_keys||{};const assignedTeamIds=Object.keys(encryptedMap);if(!assignedTeamIds.length)return;const matchingTeams=assignedTeamIds.filter(tid=>{const teamName=vault.teams[tid]?.encrypted_team.name.toLowerCase()||"";return teamName.includes(search)});if(!matchingTeams.length)return;const div=document.createElement("div");div.className="member-card";let teamListHtml=matchingTeams.map(tid=>{const teamName=vault.teams[tid]?.encrypted_team.name||"(Unknown)";return`
        <span class="team-chip">
          ${teamName}
          <button id="removeMember-${memberId}-${tid}" class="icon-button" type="button">
            <i data-lucide="square-arrow-out-up-right" style="color: #1E003B;"></i>
          </button>
        </span>
      `}).join(" ");div.innerHTML=`
      <b>${member.encrypted_vault.name}</b><br>
      Teams: ${teamListHtml}
    `;list.appendChild(div);hasAssignments=true});if(!hasAssignments){list.innerHTML=`<em>No assignments matching this team found.</em>`}resetTimer();lucide.createIcons()}function removeMemberFromTeam(memberId,teamId){const member=vault.members[memberId];if(!member)return;delete member.encrypted_vault.team_keys[teamId];resetTimer();updateAssignmentsUI();updateAllUI()}function showAddCredentialModal(){const modal=document.getElementById("credentialModal");const select=document.getElementById("credentialTeam");select.innerHTML=Object.values(vault.teams||{}).map(t=>`<option value="${t.encrypted_team.id}">${t.encrypted_team.name}</option>`).join("");modal.classList.remove("hidden");modal.classList.add("active");resetTimer()}function hideCredentialModal(){resetTimer();const modal=document.getElementById("credentialModal");modal.classList.remove("active");modal.classList.add("hidden");["credentialLabel","credentialURL","credentialUsername","credentialPassword","credentialNotes"].forEach(id=>document.getElementById(id).value="")}function addCredential(){const teamId=document.getElementById("credentialTeam").value;const label=document.getElementById("credentialLabel").value.trim();const url=document.getElementById("credentialURL").value.trim();const username=document.getElementById("credentialUsername").value.trim();const password=document.getElementById("credentialPassword").value.trim();const notes=document.getElementById("credentialNotes").value;if(!teamId||!label)return showModalAlert("Team name is required.");const cred={label:label,url:url,username:username,password:password,notes:notes};vault.teams[teamId].encrypted_team.credentials=vault.teams[teamId].encrypted_team.credentials||[];vault.teams[teamId].encrypted_team.credentials.push(cred);resetTimer();hideCredentialModal();updateCredentialsList()}function deleteCredential(teamId,index){resetTimer();const team=vault.teams[teamId];if(!team||!team.encrypted_team.credentials||!team.encrypted_team.credentials[index])return;showConfirmation("Are you sure you want to delete this credential?",confirmed=>{if(confirmed){team.encrypted_team.credentials.splice(index,1);updateCredentialsList()}})}let adminConfig=null;async function checkVaultExistence(){try{const response=await fetch("/vault/team-vault.json",{method:"GET",cache:"no-store"});if(response.ok){showScreen("adminVaultEditorPanel");resetTimer()}else{throw new Error("Vault missing")}}catch(e){showScreen("uploadAdminConfigScreen")}}function showUploadAdminConfigScreen(){showScreen("uploadAdminConfigScreen")}function handleAdminConfigUpload(event){const file=event.target.files[0];const inputField=document.getElementById("adminFileInputText");inputField.value="";if(!file)return;const reader=new FileReader;reader.onload=function(evt){try{adminConfig=JSON.parse(evt.target.result);if(!adminConfig.access_flavour||!adminConfig.totp_encrypted_secret){throw new Error("Invalid Admin Config format")}showModalAlert("✅ Admin Config loaded. Now proceed to Admin Unlock.");showScreen("adminUnlockPanel")}catch(err){console.error(err);showModalAlert("❗ Failed to load Admin Config.")}};reader.readAsText(file);resetTimer()}function logoutAdmin(){vault={};adminConfig=null;securelyEraseMemory();const fieldsToClear=["adminAccessInput","adminPasswordInput","adminTOTPInput","adminPasswordEditorInput","adminEditorTOTPInput","adminFileInputText"];fieldsToClear.forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const elementsToClear=["teamsList","membersList","credentialsList","assignmentsList","vaultExportFeedback","vaultExpirationDisplay"];elementsToClear.forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=""});const searchInputs=["teamSearchInput","memberSearchInput","credentialSearchInput","credentialSearchByTeam","assignmentSearchInput","assignmentSearchByTeam"];searchInputs.forEach(id=>{const el=document.getElementById(id);if(el)el.value=""});const qrOutput=document.getElementById("qrOutput");if(qrOutput)qrOutput.innerHTML="";const expirySortBtn=document.getElementById("toggleExpirySort");if(expirySortBtn)expirySortBtn.setAttribute("data-active","false");showScreen("memberUnlockPanel")}let teamPage=1;let memberPage=1;let assignmentPage=1;let credentialPage=1;let teamFilter="";let memberFilter="";let assignmentFilter="";let credentialFilter="";function normalizeAllExpiryDates(members){for(const[id,member]of Object.entries(members||{})){let raw=member.vault_metadata.expiry;if(!raw){member.vault_metadata.expiry=(new Date).toISOString().split("T")[0];continue}if(raw instanceof Date&&!isNaN(raw.getTime())){const yyyy=raw.getFullYear();const mm=String(raw.getMonth()+1).padStart(2,"0");const dd=String(raw.getDate()).padStart(2,"0");member.vault_metadata.expiry=`${yyyy}-${mm}-${dd}`;continue}const parsed=new Date(raw);if(!isNaN(parsed.getTime())){const yyyy=parsed.getFullYear();const mm=String(parsed.getMonth()+1).padStart(2,"0");const dd=String(parsed.getDate()).padStart(2,"0");member.vault_metadata.expiry=`${yyyy}-${mm}-${dd}`}else{member.vault_metadata.expiry=(new Date).toISOString().split("T")[0]}}}function updateMembersListSortedByExpiry(){const list=document.getElementById("membersList");const search=memberFilter.toLowerCase();list.innerHTML="";const now=new Date;const sortedMembers=Object.entries(vault.members||{}).sort(([,a],[,b])=>{return new Date(a.vault_metadata.expiry)-new Date(b.vault_metadata.expiry)});let hasMembers=false;sortedMembers.forEach(([id,member])=>{if(!member.encrypted_vault.name.toLowerCase().includes(search))return;const expiryDate=new Date(member.vault_metadata.expiry);const diffDays=Math.floor((expiryDate-now)/(1e3*60*60*24));let glowColor="";if(diffDays<0)glowColor="border: 2px solid #dc3545; background: #f8d7da;";else if(diffDays<=30)glowColor="border: 2px solid #ffc107; background: #fff3cd;";else glowColor="border: 2px solid #198754; background: #d1e7dd;";const div=document.createElement("div");div.className="member-card compact-item";let assignButton="";if(!member.vault_metadata.pending){assignButton=`<button id="assignmentButton-${id}" type="button" class="btn outline" style="margin-left:auto;"><i data-lucide="share-2"></i> Assign</button>`}const totpChecked=member.vault_metadata.totp_required==="yes"?"checked":"";div.innerHTML=`
      <div class="input-group">
        <b>${member.encrypted_vault.name}</b>
        ${member.vault_metadata.pending?'<span class="pending" style="color: #842029;">(Pending)</span>':""}
        ${member.vault_metadata.pending?`<button id="finaliseMemberButton-${id}" type="button" class="btn primary" style="margin-left:auto;"><i data-lucide="shield-check"></i> Finalize</button>`:""}
        ${assignButton}
        <button id="deleteMemberFromList-${id}" type="button" class="btn outline-secondary" style="margin-left:2rem;"><i data-lucide="trash-2"></i></button>
      </div>
      <div class="input-group" style="margin-left:4rem;">
        <div class="toggles">
          <div class="toggle-container">
            <label for="totptoggle-${id}">2FA</label>
            <input id="totptoggle-${id}" type="checkbox" class="toggle admin" ${totpChecked}>
          </div>
          <div class="toggle-container">
            <label for="dateChangeInput-${id}" style="margin-left:1rem;">Expiry</label>
            <input id="dateChangeInput-${id}" type="date" value="${member.vault_metadata.expiry}" style="max-width: none; width: auto; ${glowColor}">
          </div>
        </div>
      </div>
    `;list.appendChild(div);hasMembers=true});if(!hasMembers){list.innerHTML=`<em>No members to display.</em>`}resetTimer();lucide.createIcons()}function updateMembersList(){const list=document.getElementById("membersList");const search=memberFilter.toLowerCase();list.innerHTML="";let hasMembers=false;const sortedMembers=Object.entries(vault.members||{}).sort(([,a],[,b])=>a.encrypted_vault.name.localeCompare(b.encrypted_vault.name));sortedMembers.forEach(([id,member])=>{if(!member.encrypted_vault.name.toLowerCase().includes(search))return;const totpChecked=member.vault_metadata.totp_required==="yes"?"checked":"";const expiryValue=member.vault_metadata.expiry;const div=document.createElement("div");div.className="member-card compact-item";let assignButton="";if(!member.vault_metadata.pending){assignButton=`<button id="assignmentButton-${id}" type="button" class="btn outline" style="margin-left:auto;"><i data-lucide="share-2"></i> Assign</button>`}div.innerHTML=`
      <div class="input-group">
        <b>${member.encrypted_vault.name}</b> 
        ${member.vault_metadata.pending?'<span class="pending" style="color: #842029;">(Pending)</span>':""}
        ${member.vault_metadata.pending?`<button id="finaliseMemberButton-${id}" type="button" class="btn primary" style="margin-left:auto;"><i data-lucide="shield-check"></i> Finalize</button>`:""}
        ${assignButton}
        <button id="deleteMemberFromList-${id}" type="button" class="btn outline-secondary" style="margin-left:2rem;"><i data-lucide="trash-2"></i></button>
      </div>
      <div class="input-group" style="margin-left:4rem;">
        <div class="toggles">
          <div class="toggle-container">
            <label for="totptoggle-${id}">2FA</label>
            <input id="totptoggle-${id}" type="checkbox" class="toggle admin" ${totpChecked}>
          </div>
          <div class="toggle-container">
            <label for="dateChangeInput-${id}" style="margin-left:1rem;">Expiry</label>
            <input id="dateChangeInput-${id}" type="date" value="${expiryValue}" style="max-width: none; width: auto;">
          </div>
        </div>
      </div>
    `;list.appendChild(div);hasMembers=true});if(!hasMembers){list.innerHTML=`<em>No members to display.</em>`}resetTimer();lucide.createIcons()}function toggleTOTPRequirement(memberId,isChecked){resetTimer();if(vault.members[memberId]){vault.members[memberId].vault_metadata.totp_required=isChecked?"yes":"no"}}function updateMemberExpiry(memberId,newDate){resetTimer();if(vault.members[memberId]){vault.members[memberId].vault_metadata.expiry=newDate}}function onSearchMembers(){memberFilter=document.getElementById("memberSearchInput").value.trim();memberPage=1;resetTimer();updateMembersList()}function updateTeamsList(){const list=document.getElementById("teamsList");const search=teamFilter.toLowerCase();list.innerHTML="";let hasTeams=false;Object.entries(vault.teams||{}).forEach(([id,team])=>{if(!team.name.toLowerCase().includes(search))return;const div=document.createElement("div");div.className="team-card compact-item";div.innerHTML=`
      <b>${team.name}</b>
      <button onclick="deleteTeam('${id}')"><i data-lucide="trash-2"></i></button>
    `;list.appendChild(div);hasTeams=true});if(!hasTeams){list.innerHTML=`<em>No teams to display.</em>`}resetTimer();lucide.createIcons()}function onSearchTeams(){resetTimer();teamFilter=document.getElementById("teamSearchInput").value.trim();teamPage=1;resetTimer();updateTeamList()}function onSearchAssignments(){assignmentFilter=document.getElementById("assignmentSearchInput").value.trim();assignmentPage=1;resetTimer();updateAssignmentsUI()}function onSearchAssignmentsByTeamUI(){assignmentFilter=document.getElementById("assignmentSearchByTeam").value.trim();assignmentPage=1;resetTimer();updateAssignmentsByTeamUI()}function updateCredentialsList(){const list=document.getElementById("credentialsList");const search=credentialFilter.toLowerCase();list.innerHTML="";const allCredentials=[];Object.entries(vault.teams||{}).forEach(([teamId,team])=>{(team.encrypted_team.credentials||[]).forEach((cred,index)=>{allCredentials.push({id:`${teamId}:${index}`,teamId:teamId,index:index,...cred})})});const filtered=allCredentials.filter(c=>(c.label||"").toLowerCase().includes(search)||(c.url||"").toLowerCase().includes(search));filtered.forEach(cred=>{const div=document.createElement("div");div.className="credential-card scroll-item";div.innerHTML=`
      <div class="input-group">
        <div>
          <b>${cred.label}</b><br>
          <small>URL: ${cred.url||"(none)"}</small><br>
          Team: ${vault.teams[cred.teamId]?.encrypted_team.name||cred.teamId}<br>
        </div>
        <div class="input-group" style="margin-left: auto;">
          <button type="button" class="btn outline edit-credential-btn" data-team-id="${cred.teamId}" data-index="${cred.index}">
            <i data-lucide="edit-3"></i>
          </button>
          <button type="button" class="btn outline-secondary delete-credential-btn" data-team-id="${cred.teamId}" data-index="${cred.index}" style="margin-left: 2rem;">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      </div>
    `;list.appendChild(div)});resetTimer();lucide.createIcons()}function updateCredentialsByTeam(){const list=document.getElementById("credentialsList");const search=credentialFilter.toLowerCase();list.innerHTML="";const allCredentials=[];Object.entries(vault.teams||{}).forEach(([teamId,team])=>{(team.encrypted_team.credentials||[]).forEach((cred,index)=>{allCredentials.push({id:`${teamId}:${index}`,teamId:teamId,index:index,...cred})})});const filtered=allCredentials.filter(c=>(vault.teams[c.teamId]?.encrypted_team.name||"").toLowerCase().includes(search));filtered.forEach(cred=>{const div=document.createElement("div");div.className="credential-card scroll-item";div.innerHTML=`
      <div class="input-group">
        <div>
          <b>${cred.label}</b><br>
          <small>URL: ${cred.url||"(none)"}</small><br>
          Team: ${vault.teams[cred.teamId]?.encrypted_team.name||cred.teamId}<br>
        </div>
        <div class="input-group" style="margin-left: auto;">
          <button type="button" class="btn outline edit-credential-btn" data-team-id="${cred.teamId}" data-index="${cred.index}">
            <i data-lucide="edit-3"></i>
          </button>
          <button type="button" class="btn outline-secondary delete-credential-btn" data-team-id="${cred.teamId}" data-index="${cred.index}" style="margin-left: 2rem;">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      </div>
    `;list.appendChild(div)});if(filtered.length===0){list.innerHTML=`<em>No credentials found for this team.</em>`}resetTimer();lucide.createIcons()}function onSearchCredentials(){credentialFilter=document.getElementById("credentialSearchInput").value.trim();credentialPage=1;resetTimer();updateCredentialsList()}function onSearchCredentialsByTeam(){credentialFilter=document.getElementById("credentialSearchByTeam").value.trim();credentialPage=1;resetTimer();updateCredentialsByTeam()}let _editingCredential=null;function editCredential(teamId,index){const cred=vault.teams[teamId].encrypted_team.credentials[index];if(!cred)return;_editingCredential={teamId:teamId,index:index};document.getElementById("editCredentialLabel").value=cred.label;document.getElementById("editCredentialURL").value=cred.url;document.getElementById("editCredentialUsername").value=cred.username;document.getElementById("editCredentialPassword").value=cred.password;document.getElementById("editCredentialNotes").value=cred.notes;document.getElementById("editCredentialModal").classList.remove("hidden");resetTimer()}function saveCredentialEdit(){const{teamId,index}=_editingCredential;const cred=vault.teams[teamId].encrypted_team.credentials[index];cred.label=document.getElementById("editCredentialLabel").value.trim();cred.url=document.getElementById("editCredentialURL").value.trim();cred.username=document.getElementById("editCredentialUsername").value.trim();cred.password=document.getElementById("editCredentialPassword").value.trim();cred.notes=document.getElementById("editCredentialNotes").value.trim();resetTimer();closeEditCredentialModal();updateCredentialsList()}function closeEditCredentialModal(){document.getElementById("editCredentialModal").classList.add("hidden");_editingCredential=null}function saveEditedCredential(){const{teamId,index}=window._editingCredential||{};if(!teamId||index===undefined)return;const team=vault.teams[teamId];if(!team||!team.credentials||!team.credentials[index])return;team.credentials[index]={label:document.getElementById("editCredentialLabel").value.trim(),url:document.getElementById("editCredentialURL").value.trim(),username:document.getElementById("editCredentialUsername").value.trim(),password:document.getElementById("editCredentialPassword").value.trim()};document.getElementById("editCredentialModal").classList.add("hidden");resetTimer();updateCredentialsList()}function showEditCredentialModal(teamId,index){const team=vault.teams?.[teamId];if(!team||!team.encrypted_team.credentials||!team.encrypted_team.credentials[index]){return showModalAlert("❗ Team or credential not found.")}const cred=team.encrypted_team.credentials[index];document.getElementById("editCredentialLabel").value=cred.label||"";document.getElementById("editCredentialURL").value=cred.url||"";document.getElementById("editCredentialUsername").value=cred.username||"";document.getElementById("editCredentialPassword").value=cred.password||"";document.getElementById("editCredentialNotes").value=cred.notes||"";const saveBtn=document.getElementById("saveEditCredential");const cancelBtn=document.getElementById("cancelEditCredential");saveBtn.onclick=()=>saveCredentialChanges(teamId,index);cancelBtn.onclick=hideEditCredentialModal;document.getElementById("editCredentialModal").classList.remove("hidden");resetTimer()}function saveCredentialChanges(teamId,index){const name=document.getElementById("editCredentialLabel").value.trim();const username=document.getElementById("editCredentialUsername").value.trim();const password=document.getElementById("editCredentialPassword").value.trim();const url=document.getElementById("editCredentialURL").value.trim();const notes=document.getElementById("editCredentialNotes").value.trim();if(!name||!username||!password){showModalAlert("All fields are required.");return}const team=vault.teams[teamId];if(!team||!team.encrypted_team.credentials||!team.encrypted_team.credentials[index]){return showModalAlert("Credential not found.")}const cred=team.encrypted_team.credentials[index];cred.label=name;cred.username=username;cred.password=password;cred.url=url;cred.notes=notes;resetTimer();hideEditCredentialModal();updateCredentialsList()}function hideEditCredentialModal(){document.getElementById("editCredentialModal").classList.add("hidden");document.getElementById("editCredentialLabel").value="";document.getElementById("editCredentialUsername").value="";document.getElementById("editCredentialPassword").value="";document.getElementById("editCredentialURL").value="";document.getElementById("editCredentialNotes").value="";resetTimer()}function generateQRCodeForMember(memberName,accessSettings,totpSecret){const qrPlace=document.getElementById("hiddenQr");qrPlace.style.display="block";const qrOutput=document.getElementById("qrOutput");qrOutput.innerHTML=`<h3>${memberName}'s QR Code</h3>`;const label=encodeURIComponent(`${accessSettings}`);const issuer=encodeURIComponent("CarryPass Team");const otpUrl=`otpauth://totp/${issuer}:${label}?secret=${totpSecret}&issuer=${issuer}`;const qrDiv=document.createElement("div");qrOutput.appendChild(qrDiv);new QRCode(qrDiv,{text:otpUrl,width:220,height:220})}function startFinalizeEncryption(memberId){finalizeTargetMemberId=memberId;document.getElementById("finalizePasswordInput").value="";document.getElementById("passwordPrompt").classList.remove("hidden")}function cancelFinalize(){finalizeTargetMemberId=null;document.getElementById("passwordPrompt").classList.add("hidden");document.getElementById("finalizePasswordInput").value=""}function scrollSectionIntoView(sectionId){const section=document.getElementById(sectionId);if(section){section.scrollIntoView({behavior:"smooth",block:"start"})}}function showConfirmation(message,onConfirm){const modal=document.getElementById("confirmationModal");const messageEl=document.getElementById("confirmationMessage");const yesBtn=document.getElementById("confirmYesBtn");const noBtn=document.getElementById("confirmNoBtn");messageEl.textContent=message;const cleanup=()=>{modal.classList.add("hidden");yesBtn.onclick=null;noBtn.onclick=null};yesBtn.onclick=()=>{cleanup();onConfirm(true)};noBtn.onclick=()=>{cleanup();onConfirm(false)};modal.classList.remove("hidden")}function showModalAlert(message,onClose){const modal=document.getElementById("alertModal");const messageEl=document.getElementById("alertMessage");const okBtn=document.getElementById("alertOkBtn");messageEl.textContent=message;const cleanup=()=>{modal.classList.add("hidden");modal.classList.remove("active");okBtn.onclick=null;if(onClose)onClose()};okBtn.onclick=cleanup;modal.classList.remove("hidden");modal.classList.add("active");modal.style.zIndex="9999"}function generateMemberAccessSettings(){let firstThree="";while(true){firstThree=Array.from({length:3},()=>Math.random()<.5?"C":"X").join("");if(firstThree.includes("C"))break}const fourth=Math.random()<.5?"C":"X";const allowedLetters="ABDEFGHIJKLMNOPQRSTUVWYZ";const letterLength=Math.floor(Math.random()*4)+4;const randomLetters=Array.from({length:letterLength},()=>allowedLetters.charAt(Math.floor(Math.random()*allowedLetters.length))).join("");const lengthNumber=Math.floor(Math.random()*21)+40;const iterationNumber=Math.floor(Math.random()*899)+101;return`${firstThree}${fourth}${randomLetters}${lengthNumber}${iterationNumber}`}function securelyEraseMemory(){try{if(typeof derivedKey!=="undefined")derivedKey=null;if(typeof derivedIV!=="undefined")derivedIV=null;if(typeof derivedSalt!=="undefined")derivedSalt=null;if(typeof pseudoPad!=="undefined")pseudoPad=null}catch(e){}}async function importBase64Key(base64Key){return crypto.subtle.importKey("raw",base64ToArrayBuffer(base64Key),{name:"AES-GCM"},true,["encrypt","decrypt"])}async function importBase64RawKey(base64Key){return crypto.subtle.importKey("raw",base64ToArrayBuffer(base64Key),{name:"AES-GCM",length:256},true,["encrypt","decrypt"])}let vault={};function stableStringify(obj){return JSON.stringify(obj,Object.keys(obj).sort())}async function generateChecksum(input,secret="default-shared-secret"){const enc=new TextEncoder;const key=await crypto.subtle.importKey("raw",enc.encode(secret),{name:"HMAC",hash:"SHA-256"},false,["sign"]);const signature=await crypto.subtle.sign("HMAC",key,enc.encode(input));return btoa(String.fromCharCode(...new Uint8Array(signature)))}async function handleCompleteVaultExport(){const adminPassword=document.getElementById("adminExportPassword").value.trim();const expiry=document.getElementById("vaultExpiry").value;if(!adminPassword){showModalAlert("❗ Admin password required.");return}if(!isPasswordStrongEnough(adminPassword)){showModalAlert("❗ Password entropy too low to proceed.");return}const adminSalt=crypto.getRandomValues(new Uint8Array(16));const adminNonce=crypto.getRandomValues(new Uint8Array(12));const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(adminPassword),{name:"PBKDF2"},false,["deriveBits"]);const adminKeyRaw=await crypto.subtle.deriveBits({name:"PBKDF2",salt:adminSalt,iterations:3e5,hash:"SHA-256"},keyMaterial,256);const adminKey=await crypto.subtle.importKey("raw",adminKeyRaw,{name:"AES-GCM"},false,["encrypt","decrypt"]);const adminPayload={teams:vault.teams,members:vault.members};const adminJson=JSON.stringify(adminPayload);const adminEncryptedBuffer=await crypto.subtle.encrypt({name:"AES-GCM",iv:adminNonce},adminKey,enc.encode(adminJson));const adminEncryptedBase64=arrayBufferToBase64(adminEncryptedBuffer);const adminSaltBase64=arrayBufferToBase64(adminSalt);const adminNonceBase64=arrayBufferToBase64(adminNonce);const adminChecksum=await generateChecksum(adminEncryptedBase64+adminSaltBase64+adminNonceBase64);const members={};for(const[memberId,member]of Object.entries(vault.members)){if(!member.encrypted_vault.password_derived_key){console.error(`❗ Missing derived key for member ${memberId}`);continue}const memberNonce=crypto.getRandomValues(new Uint8Array(12));const memberKeyRaw=base64ToArrayBuffer(member.encrypted_vault.password_derived_key);const memberKey=await crypto.subtle.importKey("raw",memberKeyRaw,{name:"AES-GCM"},false,["encrypt"]);const memberEncryptedBuffer=await crypto.subtle.encrypt({name:"AES-GCM",iv:memberNonce},memberKey,enc.encode(JSON.stringify(member.encrypted_vault)));const data=arrayBufferToBase64(memberEncryptedBuffer);const nonce=arrayBufferToBase64(memberNonce);const cleanMetadata={...member.vault_metadata};delete cleanMetadata.checksum;const metadataString=stableStringify(cleanMetadata);const checksum=await generateChecksum(data+nonce+metadataString);member.vault_metadata.checksum=checksum;members[memberId]={data:data,nonce:nonce,metadata:member.vault_metadata}}const teams={};for(const[teamId,team]of Object.entries(vault.teams)){if(!team.encrypted_team.password_derived_key){console.error(`❗ Missing derived key for team ${teamId}`);continue}const teamNonce=crypto.getRandomValues(new Uint8Array(12));const teamKeyRaw=base64ToArrayBuffer(team.encrypted_team.password_derived_key);const teamKey=await crypto.subtle.importKey("raw",teamKeyRaw,{name:"AES-GCM"},false,["encrypt"]);const teamEncryptedBuffer=await crypto.subtle.encrypt({name:"AES-GCM",iv:teamNonce},teamKey,enc.encode(JSON.stringify(team.encrypted_team)));const data=arrayBufferToBase64(teamEncryptedBuffer);const nonce=arrayBufferToBase64(teamNonce);const cleanMetadata={...team.team_metadata};delete cleanMetadata.checksum;const metadataString=stableStringify(cleanMetadata);const checksum=await generateChecksum(data+nonce+metadataString);team.team_metadata.checksum=checksum;teams[teamId]={data:data,nonce:nonce,metadata:team.team_metadata}}const vaultFile={admin_vault_metadata:{created_at:(new Date).toISOString(),expiry:expiry||"",nonce:adminNonceBase64,salt:adminSaltBase64,checksum:adminChecksum},admin:adminEncryptedBase64,members:members,teams:teams};const blob=new Blob([JSON.stringify(vaultFile,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download="team-vault.json";link.click();resetTimer();showModalAlert("✅ Vault exported successfully.")}function handleVaultFileUpload(event,mode){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=async function(evt){try{const vaultJson=JSON.parse(evt.target.result);if(mode==="admin"){await handleCompleteAdminVaultImportFromFile(vaultJson)}else if(mode==="member"){await handleMemberVaultImportFromFile(vaultJson)}else{throw new Error("Unknown import mode.")}}catch(err){console.error("❌ Failed to load vault file:",err);showModalAlert("❗ Failed to import vault file. Ensure it is valid.")}};reader.readAsText(file)}async function handleCompleteAdminVaultImportFromFile(vaultJson){try{if(isViewerRateLimited()){showModalAlert("⏱ Rate limit exceeded. Please wait a minute and try again.");return}recordViewerAttempt();const adminPassword=document.getElementById("adminPasswordEditorInput").value;if(!adminPassword){showModalAlert("❗ Please enter the admin password before uploading the file.");return}const{admin_vault_metadata,admin}=vaultJson;const{nonce,salt,expiry,checksum}=admin_vault_metadata;const computedChecksum=await generateChecksum(admin+salt+nonce);if(computedChecksum!==checksum){const proceed=await confirmModal("❗ Checksum mismatch; possible tampering detected. Do you want to proceed?");if(!proceed)return}if(expiry&&new Date>new Date(expiry)){const proceed=await confirmModal("❗ Vault has expired. Do you want to continue anyway?");if(!proceed)return}await new Promise(resolve=>setTimeout(resolve,50));const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(adminPassword),{name:"PBKDF2"},false,["deriveBits"]);const adminKeyRaw=await crypto.subtle.deriveBits({name:"PBKDF2",salt:base64ToArrayBuffer(salt),iterations:3e5,hash:"SHA-256"},keyMaterial,256);const adminKey=await crypto.subtle.importKey("raw",adminKeyRaw,{name:"AES-GCM"},false,["decrypt"]);let decryptedBuffer;try{const iv=base64ToArrayBuffer(nonce);decryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},adminKey,base64ToArrayBuffer(admin))}catch(decryptErr){console.error("❌ Vault decryption failed:",decryptErr);showModalAlert("❗ Vault decryption failed. Please check the password or file integrity.");return}const decryptedJson=(new TextDecoder).decode(decryptedBuffer);const{members,teams,adminUsername}=JSON.parse(decryptedJson);normalizeAllExpiryDates(members);vault.members=members;vault.teams=teams;vault.adminUsername=adminUsername;vault.adminMetadata=admin_vault_metadata;if(admin_vault_metadata?.expiry){const expiryField=document.getElementById("vaultExpirationDisplay");if(expiryField){expiryField.innerText=admin_vault_metadata.expiry}}resetTimer();updateAllUI();showScreen("adminPanel")}catch(err){console.error("❌ Unexpected error during vault import:",err);showModalAlert("❗ Unexpected error occurred while importing the vault.")}}async function handleMemberVaultImportFromFile(vaultJson){try{if(isViewerRateLimited()){showModalAlert("⏱ Rate limit exceeded. Please wait a minute and try again.");return}recordViewerAttempt();const memberId=document.getElementById("memberId").value.trim();const memberPassword=document.getElementById("memberPassword").value;const memberBlock=vaultJson.members?.[memberId];if(!memberBlock){showModalAlert("❗ Member not found in vault.");return}const{data,nonce,metadata}=memberBlock;if(metadata?.expiry&&new Date>new Date(metadata.expiry)){showModalAlert("❗ Member vault has expired.");return}const cleanMeta={...metadata};delete cleanMeta.checksum;const memberChecksum=await generateChecksum(data+nonce+stableStringify(cleanMeta));if(memberChecksum!==metadata.checksum){showModalAlert("❗ Member block checksum mismatch; possible tampering detected.");return}let decryptedVault;try{const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(memberPassword),{name:"PBKDF2"},false,["deriveBits"]);const memberKeyRaw=await crypto.subtle.deriveBits({name:"PBKDF2",salt:base64ToArrayBuffer(metadata.salt),iterations:3e5,hash:"SHA-256"},keyMaterial,256);const memberKey=await crypto.subtle.importKey("raw",memberKeyRaw,{name:"AES-GCM"},false,["decrypt"]);const decryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:base64ToArrayBuffer(nonce)},memberKey,base64ToArrayBuffer(data));const decryptedJson=(new TextDecoder).decode(decryptedBuffer);decryptedVault=JSON.parse(decryptedJson)}catch(err){showModalAlert("❗ Failed to decrypt member vault. Please check your password.");return}decryptedVault.team_data={};const teamKeys=decryptedVault.encrypted_vault?.team_keys||decryptedVault.team_keys;if(!teamKeys||Object.keys(teamKeys).length===0){showModalAlert("✅ Member vault unlocked but no assigned teams found.");renderMemberVault(decryptedVault);showScreen("memberPanel");return}for(const[teamId,teamKeyEntry]of Object.entries(teamKeys)){try{const teamBlock=vaultJson.teams?.[teamId];if(!teamBlock)continue;const{data:teamData,nonce:teamNonce,metadata:teamMetadata}=teamBlock;const cleanTeamMeta={...teamMetadata};delete cleanTeamMeta.checksum;const expectedChecksum=await generateChecksum(teamData+teamNonce+stableStringify(cleanTeamMeta));if(expectedChecksum!==teamMetadata.checksum)continue;const keyBase64=typeof teamKeyEntry==="string"?teamKeyEntry:teamKeyEntry?.data;if(!keyBase64)continue;const teamKeyBuffer=base64ToArrayBuffer(keyBase64);const teamKey=await crypto.subtle.importKey("raw",teamKeyBuffer,{name:"AES-GCM"},false,["decrypt"]);const teamDecryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:base64ToArrayBuffer(teamNonce)},teamKey,base64ToArrayBuffer(teamData));const teamDecryptedJson=(new TextDecoder).decode(teamDecryptedBuffer);const teamDecrypted=JSON.parse(teamDecryptedJson);decryptedVault.team_data[teamId]=teamDecrypted;resetTimer()}catch(teamErr){console.error(`❗ Failed to decrypt team ${teamId}:`,teamErr);continue}}renderMemberVault(decryptedVault);showScreen("memberPanel");return decryptedVault}catch(err){showModalAlert("❗ Failed to import member vault due to unexpected error.");console.error("❗ Unexpected error in member import:",err)}}async function handleCompleteAdminVaultImport(){try{if(isViewerRateLimited()){showModalAlert("⏱ Rate limit exceeded. Please wait a minute and try again.");return}recordViewerAttempt();const adminPassword=document.getElementById("adminPasswordEditorInput").value;const response=await fetch("/vault/team-vault.json");const vaultJson=await response.json();const{admin_vault_metadata,admin}=vaultJson;const{nonce,salt,expiry,checksum}=admin_vault_metadata;const computedChecksum=await generateChecksum(admin+salt+nonce);if(computedChecksum!==checksum){const proceed=await confirmModal("❗ Checksum mismatch; possible tampering detected. Do you want to proceed?");if(!proceed)return}if(expiry&&new Date>new Date(expiry)){const proceed=await confirmModal("❗ Vault has expired. Do you want to continue anyway?");if(!proceed)return}await new Promise(resolve=>setTimeout(resolve,50));const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(adminPassword),{name:"PBKDF2"},false,["deriveBits"]);const adminKeyRaw=await crypto.subtle.deriveBits({name:"PBKDF2",salt:base64ToArrayBuffer(salt),iterations:3e5,hash:"SHA-256"},keyMaterial,256);const adminKey=await crypto.subtle.importKey("raw",adminKeyRaw,{name:"AES-GCM"},false,["decrypt"]);let decryptedBuffer;try{const iv=base64ToArrayBuffer(nonce);decryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:iv},adminKey,base64ToArrayBuffer(admin))}catch(decryptErr){console.error("❌ Vault decryption failed:",decryptErr);showModalAlert("❗ Vault decryption failed. Please check the password or file integrity.");return}const decryptedJson=(new TextDecoder).decode(decryptedBuffer);const{members,teams,adminUsername}=JSON.parse(decryptedJson);normalizeAllExpiryDates(members);vault.members=members;vault.teams=teams;vault.adminUsername=adminUsername;vault.adminMetadata=admin_vault_metadata;if(admin_vault_metadata?.expiry){const expiryField=document.getElementById("vaultExpirationDisplay");if(expiryField){expiryField.innerText=admin_vault_metadata.expiry}}resetTimer();updateAllUI();showScreen("adminPanel")}catch(err){console.error("❌ Unexpected error during vault import:",err);showModalAlert("❗ Unexpected error occurred while importing the vault.")}}async function handleMemberVaultImport(){try{if(isViewerRateLimited()){showModalAlert("⏱ Rate limit exceeded. Please wait a minute and try again.");return}recordViewerAttempt();const memberId=document.getElementById("memberId").value.trim();const memberPassword=document.getElementById("memberPassword").value;const response=await fetch("/vault/team-vault.json");const vaultJson=await response.json();const memberBlock=vaultJson.members?.[memberId];if(!memberBlock){showModalAlert("❗ Member not found in vault.");return}const{data,nonce,metadata}=memberBlock;if(metadata?.expiry&&new Date>new Date(metadata.expiry)){showModalAlert("❗ Member vault has expired.");return}const cleanMeta={...metadata};delete cleanMeta.checksum;const memberChecksum=await generateChecksum(data+nonce+stableStringify(cleanMeta));if(memberChecksum!==metadata.checksum){showModalAlert("❗ Member block checksum mismatch; possible tampering detected.");return}let decryptedVault;try{const enc=new TextEncoder;const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(memberPassword),{name:"PBKDF2"},false,["deriveBits"]);const memberKeyRaw=await crypto.subtle.deriveBits({name:"PBKDF2",salt:base64ToArrayBuffer(metadata.salt),iterations:3e5,hash:"SHA-256"},keyMaterial,256);const memberKey=await crypto.subtle.importKey("raw",memberKeyRaw,{name:"AES-GCM"},false,["decrypt"]);const decryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:base64ToArrayBuffer(nonce)},memberKey,base64ToArrayBuffer(data));const decryptedJson=(new TextDecoder).decode(decryptedBuffer);decryptedVault=JSON.parse(decryptedJson)}catch(err){showModalAlert("❗ Failed to decrypt member vault. Please check your password.");return}decryptedVault.team_data={};const teamKeys=decryptedVault.encrypted_vault?.team_keys||decryptedVault.team_keys;if(!teamKeys||Object.keys(teamKeys).length===0){showModalAlert("✅ Member vault unlocked but no assigned teams found.");renderMemberVault(decryptedVault);showScreen("memberPanel");return}for(const[teamId,teamKeyEntry]of Object.entries(teamKeys)){try{const teamBlock=vaultJson.teams?.[teamId];if(!teamBlock){continue}const{data:teamData,nonce:teamNonce,metadata:teamMetadata}=teamBlock;const cleanTeamMeta={...teamMetadata};delete cleanTeamMeta.checksum;const expectedChecksum=await generateChecksum(teamData+teamNonce+stableStringify(cleanTeamMeta));if(expectedChecksum!==teamMetadata.checksum){continue}const keyBase64=typeof teamKeyEntry==="string"?teamKeyEntry:teamKeyEntry?.data;if(!keyBase64){console.error(`❗ Missing key for team ${teamId}`);continue}const teamKeyBuffer=base64ToArrayBuffer(keyBase64);const teamKey=await crypto.subtle.importKey("raw",teamKeyBuffer,{name:"AES-GCM"},false,["decrypt"]);const teamDecryptedBuffer=await crypto.subtle.decrypt({name:"AES-GCM",iv:base64ToArrayBuffer(teamNonce)},teamKey,base64ToArrayBuffer(teamData));const teamDecryptedJson=(new TextDecoder).decode(teamDecryptedBuffer);const teamDecrypted=JSON.parse(teamDecryptedJson);decryptedVault.team_data[teamId]=teamDecrypted;resetTimer()}catch(teamErr){console.error(`❗ Failed to decrypt team ${teamId}:`,teamErr);continue}}renderMemberVault(decryptedVault);showScreen("memberPanel");return decryptedVault}catch(err){showModalAlert("❗ Failed to import member vault due to unexpected error.");console.error("❗ Unexpected error in member import:",err)}}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("adminEditFileInputText").addEventListener("change",e=>handleVaultFileUpload(e,"admin"));document.getElementById("memberGappedFileInputText").addEventListener("change",e=>handleVaultFileUpload(e,"member"))});document.addEventListener("DOMContentLoaded",()=>{document.getElementById("passCodeInputRegisterShow")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("passCodeInputShow")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("masterPass")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("iterCount")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("sixthButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("mainButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("firstButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("secondButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("thirdButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("fourthButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("fifthButton")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("editPasswordToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("createPasswordToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("memberPasswordToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("memberFinalizePasswordToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("adminPasswordInputToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("adminPasswordEditorInputToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("adminExportPasswordToggle")?.addEventListener("click",e=>{showManyPassword(e.currentTarget)});document.getElementById("clearGeneratedPasswords")?.addEventListener("click",e=>clearAllPassword(e.currentTarget));document.getElementById("collectInput")?.addEventListener("click",e=>collectInputData(e.currentTarget));document.getElementById("onAdminEntryCheck")?.addEventListener("click",onAdminEntry);document.getElementById("memberUnlockScreen")?.addEventListener("click",()=>showScreen("memberUnlockPanel"));document.getElementById("uploadConfigToMemberPanel")?.addEventListener("click",()=>showScreen("memberUnlockPanel"));document.getElementById("logoutAdminEditDesktop")?.addEventListener("click",logoutAdmin);document.getElementById("logoutAdminEditMobile")?.addEventListener("click",logoutAdmin);document.getElementById("logoutMemberFromVault")?.addEventListener("click",logoutAdmin);document.getElementById("teamSearchInput")?.addEventListener("input",()=>onSearchTeams());document.getElementById("createTeamModal")?.addEventListener("click",showCreateTeamModal);document.getElementById("createTeamUnit")?.addEventListener("click",createTeam);document.getElementById("hideCreateTeamUnit")?.addEventListener("click",hideCreateTeamModal);document.addEventListener("click",e=>{const btn=e.target.closest('[id^="deleteTeamButton-"]');if(btn){const id=btn.id.replace("deleteTeamButton-","");deleteTeam(id)}});document.addEventListener("click",e=>{const btn=e.target.closest('[id^="deleteMemberFromList-"]');if(btn){const id=btn.id.replace("deleteMemberFromList-","");deleteMember(id)}});document.addEventListener("click",e=>{const btn=e.target.closest('[id^="assignmentButton-"]');if(btn){const id=btn.id.replace("assignmentButton-","");openAssignMemberToTeamModal(id)}});document.addEventListener("click",e=>{const btn=e.target.closest('[id^="finaliseMemberButton-"]');if(btn){const id=btn.id.replace("finaliseMemberButton-","");openMemberFinalizeModal(id)}});document.addEventListener("click",e=>{const editBtn=e.target.closest(".edit-credential-btn");if(editBtn){const teamId=editBtn.dataset.teamId;const index=parseInt(editBtn.dataset.index,10);showEditCredentialModal(teamId,index);return}const deleteBtn=e.target.closest(".delete-credential-btn");if(deleteBtn){const teamId=deleteBtn.dataset.teamId;const index=parseInt(deleteBtn.dataset.index,10);deleteCredential(teamId,index)}});document.addEventListener("click",e=>{const button=e.target.closest('[id^="credBlockShow__"]');if(button){showManyPassword(button)}});document.addEventListener("click",e=>{const btn=e.target.closest(".open-url-button");if(!btn)return;const url=btn.getAttribute("data-url");if(url&&url.startsWith("https://")){window.open(url,"_blank")}else{showModalAlert("Not a clickable URL")}});document.addEventListener("change",e=>{const toggle=e.target.closest(".toggle");if(toggle&&toggle.id.startsWith("totptoggle-")){const id=toggle.id.replace("totptoggle-","");toggleTOTPRequirement(id,toggle.checked)}});document.addEventListener("change",e=>{const input=e.target.closest('[id^="dateChangeInput-"]');if(input){const id=input.id.replace("dateChangeInput-","");updateMemberExpiry(id,input.value)}});document.addEventListener("click",e=>{const btn=e.target.closest('[id^="removeMember-"]');if(btn){const[memberId,tid]=btn.id.replace("removeMember-","").split("-");removeMemberFromTeam(memberId,tid)}});document.getElementById("toggleExpirySort").addEventListener("click",e=>{const button=e.currentTarget;const isActive=button.getAttribute("data-active")==="true";if(isActive){button.setAttribute("data-active","false");button.classList.remove("active");updateMembersList()}else{button.setAttribute("data-active","true");button.classList.add("active");updateMembersListSortedByExpiry()}});document.addEventListener("click",e=>{const btn=e.target.closest("[data-password-id]");if(btn){copyPasswordCheck(btn)}});document.getElementById("toggleInfoWhatisit")?.addEventListener("click",toggleInfo);document.getElementById("toggleInfoWhatisitEntry")?.addEventListener("click",toggleInfoEntry);document.getElementById("backToTeamsPanel")?.addEventListener("click",()=>showScreen("memberUnlockPanel"));document.getElementById("firstUnlockAdminVault")?.addEventListener("click",adminUnlockVault);document.getElementById("memberVaultImportButton")?.addEventListener("click",handleMemberVaultImport);document.getElementById("handleCompleteAdminVault")?.addEventListener("click",handleCompleteAdminVaultImport);document.getElementById("adminToMemberUnlock")?.addEventListener("click",()=>showScreen("memberUnlockPanel"));document.getElementById("credentialSearchInput")?.addEventListener("input",()=>onSearchCredentials());document.getElementById("credentialSearchByTeam")?.addEventListener("input",()=>onSearchCredentialsByTeam());document.getElementById("addCredentialButton")?.addEventListener("click",showAddCredentialModal);document.getElementById("addCredentialByModal")?.addEventListener("click",addCredential);document.getElementById("hideCredentialAddModal")?.addEventListener("click",hideCredentialModal);document.getElementById("memberSearchInput")?.addEventListener("input",()=>onSearchMembers());document.getElementById("createMemberShow")?.addEventListener("click",showCreateMemberModal);document.getElementById("realCreateMember")?.addEventListener("click",createMember);document.getElementById("realCreateMemberHide")?.addEventListener("click",hideCreateMemberModal);document.getElementById("assignmentSearchInput")?.addEventListener("input",()=>onSearchAssignments());document.getElementById("assignmentSearchByTeam")?.addEventListener("input",()=>onSearchAssignmentsByTeamUI());document.getElementById("removeTeamMemberAssignment")?.addEventListener("click",()=>removeMemberFromTeam("{{ member.id }}","{{ this.id }}"));document.getElementById("vaultExportModalShow")?.addEventListener("click",showExportModal);document.getElementById("cancelAssignButton")?.addEventListener("click",closeAssignMemberModal);document.getElementById("assignMemberButton")?.addEventListener("click",confirmAssignMemberToTeam);document.getElementById("closeMemberFinalizeButton")?.addEventListener("click",closeMemberFinalizeModal);document.getElementById("memberFinalizeButton")?.addEventListener("click",finalizeMember);document.getElementById("cancelAdminExport")?.addEventListener("click",closeExportModal);document.getElementById("adminExportsVault")?.addEventListener("click",handleCompleteVaultExport);document.getElementById("deleteQrOutput")?.addEventListener("click",deleteQrCode);document.getElementById("adminPasswordGenerator1")?.addEventListener("click",openAdminPasswordModal);document.getElementById("adminPasswordGenerator2")?.addEventListener("click",openAdminPasswordModal);document.getElementById("closeAdminPasswordGenerator")?.addEventListener("click",closeAdminPasswordModal)});function updateAdminFileName(){const fileInputAdmin=document.getElementById("adminFileInput");const fileInputTextAdmin=document.getElementById("adminFileInputText");const fileNameAdmin=fileInputAdmin.files[0]?fileInputAdmin.files[0].name:"Choose file";fileInputTextAdmin.value=fileNameAdmin}const adminFileButton=document.getElementById("adminFileButton");const adminFileInput=document.getElementById("adminFileInput");if(adminFileButton&&adminFileInput){adminFileButton.addEventListener("click",function(){adminFileInput.click()})}if(adminFileInput){adminFileInput.addEventListener("change",event=>{updateAdminFileName();handleAdminConfigUpload(event)})}function updateAdminEditFileName(){const fileInput=document.getElementById("adminEditFileInput");const fileNameField=document.getElementById("adminEditFileInputText");const fileName=fileInput.files[0]?fileInput.files[0].name:"Choose file";fileNameField.value=fileName}const adminEditFileButton=document.getElementById("adminEditFileButton");const adminEditFileInput=document.getElementById("adminEditFileInput");if(adminEditFileButton&&adminEditFileInput){adminEditFileButton.addEventListener("click",()=>{adminEditFileInput.click()})}if(adminEditFileInput){adminEditFileInput.addEventListener("change",event=>{updateAdminEditFileName();const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=async function(e){try{const vaultJson=JSON.parse(e.target.result);await handleCompleteAdminVaultImportFromFile(vaultJson)}catch(err){console.error("❌ Error importing admin vault:",err);showModalAlert("❗ Failed to import admin vault file.")}finally{adminEditFileInput.value=""}};reader.readAsText(file)})}function updateMemberGappedFileName(){const fileInput=document.getElementById("memberGappedFileInput");const fileNameField=document.getElementById("memberGappedFileInputText");const fileName=fileInput.files[0]?fileInput.files[0].name:"Choose file";fileNameField.value=fileName}const memberGappedFileButton=document.getElementById("memberGappedFileButton");const memberGappedFileInput=document.getElementById("memberGappedFileInput");if(memberGappedFileButton&&memberGappedFileInput){memberGappedFileButton.addEventListener("click",()=>{memberGappedFileInput.click()})}if(memberGappedFileInput){memberGappedFileInput.addEventListener("change",event=>{updateMemberGappedFileName();const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=async function(e){try{const vaultJson=JSON.parse(e.target.result);await handleMemberVaultImportFromFile(vaultJson)}catch(err){console.error("❌ Error importing member vault:",err);showModalAlert("❗ Failed to import member vault file.")}finally{memberGappedFileInput.value=""}};reader.readAsText(file)})}const ENTROPY_THRESHOLDS={low:128,good:256};function calculateEntropyMaster(password){if(!password||typeof password!=="string")return 0;try{const charsetSize=new Set(password.split("")).size||1;return password.length*Math.log2(charsetSize)}catch(err){console.error("Entropy calculation error:",err);return 0}}function updatePasswordStrengthMaster(password){const bar=document.getElementById("passwordStrengthBarAdmin");const label=document.getElementById("passwordStrengthTextAdmin");const entropyLabel=document.getElementById("entropyTextAdmin");if(!password){label.innerText="";entropyLabel.innerText="";bar.className="";return}const entropy=calculateEntropyMaster(password);let strength="low";if(entropy>=ENTROPY_THRESHOLDS.good){strength="excellent"}else if(entropy>=ENTROPY_THRESHOLDS.low){strength="good"}bar.className="";bar.classList.add(strength);const colors={low:"red",good:"orange",excellent:"green"};label.innerText=strength.charAt(0).toUpperCase()+strength.slice(1);label.style.color=colors[strength];entropyLabel.innerText=`Entropy: ${entropy.toFixed(2)} (${strength})`}function updatePasswordStrengthAdmin(password){const bar=document.getElementById("passwordStrengthBarAdminPlus");const label=document.getElementById("passwordStrengthTextAdminPlus");const entropyLabel=document.getElementById("entropyTextAdminPlus");if(!password){label.innerText="";entropyLabel.innerText="";bar.className="";return}const entropy=calculateEntropyMaster(password);let strength="low";if(entropy>=ENTROPY_THRESHOLDS.good){strength="excellent"}else if(entropy>=ENTROPY_THRESHOLDS.low){strength="good"}bar.className="";bar.classList.add(strength);const colors={low:"red",good:"orange",excellent:"green"};label.innerText=strength.charAt(0).toUpperCase()+strength.slice(1);label.style.color=colors[strength];entropyLabel.innerText=`Entropy: ${entropy.toFixed(2)} (${strength})`}function updatePasswordStrengthMember(password){const bar=document.getElementById("passwordStrengthBarMember");const label=document.getElementById("passwordStrengthTextMember");const entropyLabel=document.getElementById("entropyTextMember");if(!password){label.innerText="";entropyLabel.innerText="";bar.className="";return}const entropy=calculateEntropyMaster(password);let strength="low";if(entropy>=ENTROPY_THRESHOLDS.good){strength="excellent"}else if(entropy>=ENTROPY_THRESHOLDS.low){strength="good"}bar.className="";bar.classList.add(strength);const colors={low:"red",good:"orange",excellent:"green"};label.innerText=strength.charAt(0).toUpperCase()+strength.slice(1);label.style.color=colors[strength];entropyLabel.innerText=`Entropy: ${entropy.toFixed(2)} (${strength})`}const mainPasswordInput=document.getElementById("adminExportPassword");if(mainPasswordInput){mainPasswordInput.addEventListener("input",e=>updatePasswordStrengthMaster(e.target.value));mainPasswordInput.addEventListener("blur",e=>updatePasswordStrengthMaster(e.target.value))}const mainPasswordInputAdmin=document.getElementById("mainPasswordAdmin");if(mainPasswordInputAdmin){mainPasswordInputAdmin.addEventListener("input",e=>updatePasswordStrengthAdmin(e.target.value));mainPasswordInputAdmin.addEventListener("blur",e=>updatePasswordStrengthAdmin(e.target.value))}const mainPasswordInputMember=document.getElementById("memberFinalizeMasterPassword");if(mainPasswordInputMember){mainPasswordInputMember.addEventListener("input",e=>updatePasswordStrengthMember(e.target.value));mainPasswordInputMember.addEventListener("blur",e=>updatePasswordStrengthMember(e.target.value))}function isPasswordStrongEnough(password){return calculateEntropyMaster(password)>=ENTROPY_THRESHOLDS.low}function openAdminPasswordModal(){document.getElementById("adminPasswordGeneratorModal").classList.remove("hidden");document.getElementById("adminPasswordGeneratorModal").classList.add("active");resetTimer()}function closeAdminPasswordModal(){document.getElementById("adminPasswordGeneratorModal").classList.add("hidden");document.getElementById("adminPasswordGeneratorModal").classList.remove("active");document.getElementById("webAddressAdmin").value="";document.getElementById("passwordAdmin").value="";document.getElementById("lengthAdmin").value=43;document.getElementById("iterationCountAdmin").value=5e4;document.getElementById("mainPasswordAdmin").value="";document.getElementById("passwordStrengthBarAdminPlus").innerText="";document.getElementById("passwordStrengthTextAdminPlus").innerText="";document.getElementById("entropyTextAdminPlus").innerText="";document.getElementById("createdforAdmin").innerText="";document.getElementById("toggle1Admin").checked=false;document.getElementById("toggle2Admin").checked=false;document.getElementById("toggle3Admin").checked=false;document.getElementById("toggle4Admin").checked=false;resetTimer()}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("masterPassAdmin")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("mainButtonAdmin")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("iterCountAdmin")?.addEventListener("click",e=>showManyPassword(e.currentTarget));document.getElementById("collectInputAdmin")?.addEventListener("click",async()=>{const result=await collectInputDataAdmin();if(result){updatePasswordStrengthAdmin(result)}})});async function collectInputDataAdmin(){const button=document.getElementById("collectInputAdmin");const status=document.getElementById("generationStatusAdmin");const webAddressField=document.getElementById("webAddressAdmin");const passwordField=document.getElementById("passwordAdmin");if(!webAddressField.value.trim()){webAddressField.focus();return null}if(!passwordField.value.trim()){passwordField.focus();return null}if(passwordField.value.trim().length<12){showModalAlert("Master password must be at least 12 characters. For strong security, use 16 or more.");passwordField.focus();return null}button.disabled=true;status.style.visibility="visible";const webAddressInput=webAddressField.value;const passwordInput=passwordField.value;const lengthInput=parseInt(document.getElementById("lengthAdmin").value,10);const iterationCountInput=parseInt(document.getElementById("iterationCountAdmin").value,10);const lettersChecked=document.getElementById("toggle1Admin").checked;const numbersChecked=document.getElementById("toggle2Admin").checked;const symbolsChecked=document.getElementById("toggle3Admin").checked;const separatorChecked=document.getElementById("toggle4Admin").checked;const charTypes={letters:lettersChecked,numbers:numbersChecked,symbols:symbolsChecked};resetTimer();await new Promise(resolve=>setTimeout(resolve,10));const generatedPassword=await generateDeterministicPasswordsWithAESCTRAdmin(webAddressInput,passwordInput,lengthInput,iterationCountInput,charTypes,separatorChecked);button.disabled=false;status.style.visibility="hidden";return generatedPassword}async function generateDeterministicPasswordsWithAESCTRAdmin(webAddress,masterPassword,length,iterationCount,charTypes,segmented=false){const supplementaryInputs=["mainPasswordAdmin"];const normalizedService=normalizeServiceName(webAddress);let charset="";if(charTypes.letters)charset+=PASSWORDCHARSETS.upperAlpha+PASSWORDCHARSETS.lowerAlpha;if(charTypes.numbers)charset+=PASSWORDCHARSETS.numbers;if(charTypes.symbols)charset+=PASSWORDCHARSETS.special;if(!charset){showModalAlert("Please select at least one character type: Letters, Numbers, or Symbols.");return[]}const saltInputArgon=normalizedService+"::"+iterationCount+"::"+length;const argonSalt=(new TextEncoder).encode(saltInputArgon);const options=mapArgonOptions(iterationCount);const argonHash=await argon2.hash({pass:masterPassword,salt:argonSalt,...options,hashLen:32,raw:true});const argonEnhancer=Array.from(argonHash.hash).map(b=>b.toString(16).padStart(2,"0")).join("");const saltInput=normalizedService+"::"+iterationCount+"::"+length+"::"+argonEnhancer;const salt=CryptoJS.SHA256(saltInput).toString();const key=CryptoJS.PBKDF2(masterPassword,salt,{keySize:256/32,iterations:getEffectivePBKDF2Iterations(iterationCount),hasher:CryptoJS.algo.SHA256});for(let index=0;index<1;index++){let password="";let blockCounter=0;while(password.length<length){const counterIvHex=CryptoJS.SHA256(`pwgen::${normalizedService}::${index}::${blockCounter}`).toString().substring(0,32);const iv=CryptoJS.enc.Hex.parse(counterIvHex);const inputBlock=CryptoJS.enc.Hex.parse("00000000000000000000000000000000");const encrypted=CryptoJS.AES.encrypt(inputBlock,key,{mode:CryptoJS.mode.CTR,iv:iv,padding:CryptoJS.pad.NoPadding});const stream=encrypted.ciphertext.words;for(let i=0;i<stream.length*4&&password.length<length;i++){const word=stream[Math.floor(i/4)]>>>24-i%4*8;password+=charset.charAt(word%charset.length)}blockCounter++}if(segmented){password=segmentKey(password,7)}document.getElementById(supplementaryInputs[index]).value=password}const generated=document.getElementById("generatedPasswordAdmin");showSmooth(generated);document.getElementById("createdforAdmin").innerHTML="for "+"<b>"+webAddress+"</b>";document.getElementById("webAddressAdmin").value="";document.getElementById("passwordAdmin").value="";document.getElementById("generationStatusAdmin").style.visibility="hidden";updateCounter();resetTimer();return document.getElementById("mainPasswordAdmin").value}function updateArgonTierLabel(){const input=document.getElementById("iterationCount");const label=document.getElementById("argonTierLabel");const val=parseInt(input.value);if(isNaN(val)||val<=0){label.textContent="";return}if(val>66666){label.textContent="🔺 Extreme"}else if(val>33333){label.textContent="🔸 Hardened"}else{label.textContent="🔹 Standard"}}const iterationInput=document.getElementById("iterationCount");iterationInput.addEventListener("input",updateArgonTierLabel);iterationInput.addEventListener("blur",updateArgonTierLabel);document.addEventListener("DOMContentLoaded",updateArgonTierLabel);iterationInput.addEventListener("change",updateArgonTierLabel);function toggleInfo(){const content=document.getElementById("infoContent");const arrow=document.getElementById("infoArrow");const isOpen=content.style.display==="block";content.style.display=isOpen?"none":"block";arrow.textContent=isOpen?"▼":"▲";arrow.classList.toggle("expanded",!isOpen)}function toggleInfoEntry(){const content=document.getElementById("infoContentEntry");const arrow=document.getElementById("infoArrowEntry");const isOpen=content.style.display==="block";content.style.display=isOpen?"none":"block";arrow.textContent=isOpen?"▼":"▲";arrow.classList.toggle("expanded",!isOpen)}document.querySelectorAll(".info-icon-wrapper").forEach(button=>{button.addEventListener("click",()=>{const tooltipId=button.getAttribute("aria-describedby");const tooltip=document.getElementById(tooltipId);const alreadyVisible=tooltip.classList.contains("visible");document.querySelectorAll(".tooltip.visible").forEach(t=>t.classList.remove("visible"));if(!alreadyVisible&&tooltip){tooltip.classList.add("visible");requestAnimationFrame(()=>{positionTooltip(tooltip)})}})});document.addEventListener("click",e=>{if(!e.target.closest(".info-icon-wrapper")){document.querySelectorAll(".tooltip.visible").forEach(t=>t.classList.remove("visible"))}});window.addEventListener("scroll",()=>{document.querySelectorAll(".tooltip.visible").forEach(t=>t.classList.remove("visible"))});function positionTooltip(tooltip){tooltip.style.left="50%";tooltip.style.right="auto";tooltip.style.transform="translateX(-50%)";const tooltipRect=tooltip.getBoundingClientRect();const columnWrapper=tooltip.closest(".column-left, .column-right");if(!columnWrapper)return;const columnRect=columnWrapper.getBoundingClientRect();const padding=8;const overflowLeft=tooltipRect.left<columnRect.left+padding;const overflowRight=tooltipRect.right>columnRect.right-padding;if(overflowLeft){tooltip.style.left=`${padding}px`;tooltip.style.right="auto";tooltip.style.transform="none"}else if(overflowRight){tooltip.style.right=`${padding}px`;tooltip.style.left="auto";tooltip.style.transform="none"}}